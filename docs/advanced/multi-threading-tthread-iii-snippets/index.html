<!DOCTYPE html><html lang="en" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://ikelaiah.github.io/free-pascal-cookbook/docs/advanced/multi-threading-tthread-iii-snippets/">
      
      
        <link rel="prev" href="../multi-threading-tthread-ii-cs/">
      
      
        <link rel="next" href="../ezthreads/">
      
      
      <link rel="icon" href="../../../assets/logo-new-rounded-min.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.21">
    
    
      
        <title>TThread - Pt 3. Snippets - Free Pascal Cookbook</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.2a3383ac.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CFira+Code:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Fira Code"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#multi-threading-with-tthread-part-iii-snippets" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Free Pascal Cookbook" class="md-header__button md-logo" aria-label="Free Pascal Cookbook" data-md-component="logo">
      
  <img src="../../../assets/logo-new-rounded-min.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Free Pascal Cookbook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              TThread - Pt 3. Snippets
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="orange" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="orange" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../basics/intro-objpas-fpc/" class="md-tabs__link">
          
  
  
  Basics

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../core-tasks/overview/" class="md-tabs__link">
          
  
  
  Core Tasks

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../overview/" class="md-tabs__link">
          
  
  
  Advanced Topics

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../external-systems/overview/" class="md-tabs__link">
          
  
  
  External Systems

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../community/" class="md-tabs__link">
        
  
  
    
  
  Community

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../resources/docs-sites/" class="md-tabs__link">
          
  
  
  Resources

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Free Pascal Cookbook" class="md-nav__button md-logo" aria-label="Free Pascal Cookbook" data-md-component="logo">
      
  <img src="../../../assets/logo-new-rounded-min.png" alt="logo">

    </a>
    Free Pascal Cookbook
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1">
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    About
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../LICENSE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    License
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Basics
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Basics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../basics/intro-objpas-fpc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Intro to Free Pascal
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../basics/common-data-types/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Common Data Types
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../basics/install/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup FPC &amp; Lazarus IDE
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../basics/basic-hello-world/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running a 'Hello, World!'
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3">
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Core Tasks
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Core Tasks
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/lazarus-ide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lazarus IDE
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/code-structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Code Structure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/cmd-line-params/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Command Line Parameters
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/funcs-procs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Functions &amp; Procedures
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/immutability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Immutability
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/loops/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Loops
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/arrays/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Arrays
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/lists/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lists
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/strings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Strings
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/numbers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Numbers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/dates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dates &amp; Times
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/regex/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Regular Expressions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/dir-path-filename/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Directories, Paths and Files
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/exception-try-blocks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Exceptions
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/file-handling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    File Handling I
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/file-handling-ii/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    File Handling II
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../core-tasks/zip-and-unzip/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Zip and Unzip
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Advanced Topics
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Advanced Topics
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lmath/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Math with LMath
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../numlib-summary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Numerical - NumLib | Summary
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../numlib/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Numerical - NumLib | Examples
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../conditional-compilation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Conditional Compilation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Debugging with Lazarus IDE
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../find-heap-memory-leaks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Find Heap Memory Leaks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multi-threading-basics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi-threading - Basics
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multi-threading-tthread-i-intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TThread - Pt 1. Intro
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multi-threading-tthread-ii-cs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TThread - Pt 2. Critical Section
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    TThread - Pt 3. Snippets
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    TThread - Pt 3. Snippets
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#run-a-task-on-a-thread-with-a-variable" class="md-nav__link">
    <span class="md-ellipsis">
      Run a task on a thread with a variable
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-same-tasks-on-multiple-threads" class="md-nav__link">
    <span class="md-ellipsis">
      Run same tasks on multiple threads
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sum-numbers-in-an-array" class="md-nav__link">
    <span class="md-ellipsis">
      Sum numbers in an array
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#increment-a-counter-multi-threading" class="md-nav__link">
    <span class="md-ellipsis">
      Increment a counter multi-threading
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assigns-student-ids-to-student-names" class="md-nav__link">
    <span class="md-ellipsis">
      Assigns student IDs to student names
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Assigns student IDs to student names">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-commonpas-of-assigning-ids-to-names" class="md-nav__link">
    <span class="md-ellipsis">
      The common.pas of assigning IDs to names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-customthreadpas-of-assigning-ids-to-names" class="md-nav__link">
    <span class="md-ellipsis">
      The customthread.pas of assigning IDs to names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-main-program-of-assigning-ids-to-names" class="md-nav__link">
    <span class="md-ellipsis">
      The main program of assigning IDs to names
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-large-text-file-parser" class="md-nav__link">
    <span class="md-ellipsis">
      A Large Text File Parser
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ezthreads/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Using ezthreads
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fpc-switches/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FPC Switches
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5">
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    External Systems
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            External Systems
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../external-systems/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../external-systems/parsing-json/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Parsing JSON
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../external-systems/webserver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Web Server
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../community/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Community
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7">
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Resources
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Resources
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/docs-sites/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Documents &amp; Sites
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/fpc-laz-packages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    FPC &amp; Lazarus Packages
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../resources/videos/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Videos
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#run-a-task-on-a-thread-with-a-variable" class="md-nav__link">
    <span class="md-ellipsis">
      Run a task on a thread with a variable
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-same-tasks-on-multiple-threads" class="md-nav__link">
    <span class="md-ellipsis">
      Run same tasks on multiple threads
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sum-numbers-in-an-array" class="md-nav__link">
    <span class="md-ellipsis">
      Sum numbers in an array
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#increment-a-counter-multi-threading" class="md-nav__link">
    <span class="md-ellipsis">
      Increment a counter multi-threading
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#assigns-student-ids-to-student-names" class="md-nav__link">
    <span class="md-ellipsis">
      Assigns student IDs to student names
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Assigns student IDs to student names">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-commonpas-of-assigning-ids-to-names" class="md-nav__link">
    <span class="md-ellipsis">
      The common.pas of assigning IDs to names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-customthreadpas-of-assigning-ids-to-names" class="md-nav__link">
    <span class="md-ellipsis">
      The customthread.pas of assigning IDs to names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-main-program-of-assigning-ids-to-names" class="md-nav__link">
    <span class="md-ellipsis">
      The main program of assigning IDs to names
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-large-text-file-parser" class="md-nav__link">
    <span class="md-ellipsis">
      A Large Text File Parser
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="multi-threading-with-tthread-part-iii-snippets">Multi-threading with <code>TThread</code> Part III - Snippets<a class="headerlink" href="#multi-threading-with-tthread-part-iii-snippets" title="Permanent link">¶</a></h1>
<p>Here are collections of snippets solving various tasks using multi-threading.</p>
<h2 id="run-a-task-on-a-thread-with-a-variable">Run a task on a thread with a variable<a class="headerlink" href="#run-a-task-on-a-thread-with-a-variable" title="Permanent link">¶</a></h2>
<div class="language-pascal highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-0-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-0-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-0-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-0-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-0-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-0-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-0-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-0-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-0-10">10</a></span>
<span class="normal"><a href="#__codelineno-0-11">11</a></span>
<span class="normal"><a href="#__codelineno-0-12">12</a></span>
<span class="normal"><a href="#__codelineno-0-13">13</a></span>
<span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span>
<span class="normal"><a href="#__codelineno-0-79">79</a></span>
<span class="normal"><a href="#__codelineno-0-80">80</a></span>
<span class="normal"><a href="#__codelineno-0-81">81</a></span>
<span class="normal"><a href="#__codelineno-0-82">82</a></span>
<span class="normal"><a href="#__codelineno-0-83">83</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="k">program</span><span class="w"> </span><span class="n">EX1SingleThread</span><span class="o">;</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="cm">{$mode objfpc}{$H+}{$J-}</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="k">uses</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="w">  </span><span class="cm">{$IFDEF UNIX}</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a><span class="w">  </span><span class="n">cmem</span><span class="o">,</span><span class="w"> </span><span class="n">cthreads</span><span class="o">,</span>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="w">  </span><span class="cm">{$ENDIF}</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="w">  </span><span class="n">Classes</span><span class="w"> </span><span class="cm">{ you can add units after this }</span><span class="o">;</span>
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10"></a>
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="k">type</span>
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">  </span><span class="c1">// The TThread class encapsulates the native thread support of the OS.</span>
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="w">  </span><span class="c1">// To create a thread, (1) declare a child of the TThread object, ...</span>
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">  </span><span class="n">TMyThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">class</span><span class="p">(</span><span class="n">TThread</span><span class="p">)</span>
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="c1">// (with a data to work with)</span>
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="w">  </span><span class="kp">private</span>
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="w">    </span><span class="n">aString</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="w">  </span><span class="kp">protected</span>
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="w">    </span><span class="c1">// (2) override the Execute method, and ...</span>
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">Execute</span><span class="o">;</span><span class="w"> </span><span class="kp">override</span><span class="o">;</span>
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">  </span><span class="kp">public</span>
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="w">    </span><span class="c1">// (3) lastly, you may include a constructor to setup variables</span>
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="w">    </span><span class="c1">// for executing this thread.</span>
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="k">constructor</span><span class="w"> </span><span class="nf">Create</span><span class="p">(</span><span class="n">isSuspended</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="o">;</span><span class="w"> </span><span class="n">message</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26"></a>
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="w">  </span><span class="k">constructor</span><span class="w"> </span><span class="nc">TMyThread</span><span class="o">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">isSuspended</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="o">;</span><span class="w"> </span><span class="n">message</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29"></a>
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="w">    </span><span class="c1">// Call parent's constructor</span>
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="w">    </span><span class="c1">// If user pass True, thread won't start automatically</span>
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="w">    </span><span class="k">inherited</span><span class="w"> </span><span class="n">Create</span><span class="p">(</span><span class="n">isSuspended</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33"></a>
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">    </span><span class="c1">// Assign a data to work with.</span>
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="w">    </span><span class="k">self</span><span class="o">.</span><span class="n">aString</span><span class="o">:=</span><span class="n">message</span><span class="o">;</span>
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36"></a>
</span><span id="__span-0-37"><a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="w">    </span><span class="c1">// Won't free the thread when finished.</span>
</span><span id="__span-0-38"><a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="w">    </span><span class="c1">// The thread will be freed manually on the main block.</span>
</span><span id="__span-0-39"><a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="w">    </span><span class="n">FreeOnTerminate</span><span class="o">:=</span><span class="k">False</span><span class="o">;</span>
</span><span id="__span-0-40"><a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-0-41"><a id="__codelineno-0-41" name="__codelineno-0-41"></a>
</span><span id="__span-0-42"><a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="w">  </span><span class="k">procedure</span><span class="w"> </span><span class="nc">TMyThread</span><span class="o">.</span><span class="nf">Execute</span><span class="o">;</span>
</span><span id="__span-0-43"><a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-0-44"><a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">    </span><span class="c1">// Execute thread, and DO SOMETHING in this thread.</span>
</span><span id="__span-0-45"><a id="__codelineno-0-45" name="__codelineno-0-45"></a>
</span><span id="__span-0-46"><a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="w">    </span><span class="c1">// Example: if the thread has a data to work with,</span>
</span><span id="__span-0-47"><a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="w">    </span><span class="c1">//          use it to achieve a goal.</span>
</span><span id="__span-0-48"><a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Thread ID '</span><span class="o">,</span><span class="w"> </span><span class="n">ThreadID</span><span class="o">,</span><span class="w"> </span><span class="s">' is printing '</span><span class="o">,</span><span class="w"> </span><span class="k">self</span><span class="o">.</span><span class="n">aString</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-0-49"><a id="__codelineno-0-49" name="__codelineno-0-49"></a>
</span><span id="__span-0-50"><a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">    </span><span class="c1">// Example: simulate a long running process.</span>
</span><span id="__span-0-51"><a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="w">    </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-0-52"><a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-0-53"><a id="__codelineno-0-53" name="__codelineno-0-53"></a>
</span><span id="__span-0-54"><a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="k">var</span>
</span><span id="__span-0-55"><a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="w">  </span><span class="n">mythread</span><span class="o">:</span><span class="n">TMyThread</span><span class="o">;</span>
</span><span id="__span-0-56"><a id="__codelineno-0-56" name="__codelineno-0-56"></a>
</span><span id="__span-0-57"><a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="c1">// Main block --------------------------------------------------</span>
</span><span id="__span-0-58"><a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="k">begin</span>
</span><span id="__span-0-59"><a id="__codelineno-0-59" name="__codelineno-0-59"></a>
</span><span id="__span-0-60"><a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="c1">// Create a thread, suspended</span>
</span><span id="__span-0-61"><a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="n">myThread</span><span class="o">:=</span><span class="n">TMyThread</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="k">True</span><span class="o">,</span><span class="w"> </span><span class="s">'Hello, World!'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-0-62"><a id="__codelineno-0-62" name="__codelineno-0-62"></a>
</span><span id="__span-0-63"><a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="c1">// Debug line</span>
</span><span id="__span-0-64"><a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'We are in the main thread'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-0-65"><a id="__codelineno-0-65" name="__codelineno-0-65"></a>
</span><span id="__span-0-66"><a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="c1">// Start the thread</span>
</span><span id="__span-0-67"><a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="n">myThread</span><span class="o">.</span><span class="n">Start</span><span class="o">;</span>
</span><span id="__span-0-68"><a id="__codelineno-0-68" name="__codelineno-0-68"></a>
</span><span id="__span-0-69"><a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="c1">// Wait until the thread is done before going back to</span>
</span><span id="__span-0-70"><a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="c1">// the main thread.</span>
</span><span id="__span-0-71"><a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="n">myThread</span><span class="o">.</span><span class="n">WaitFor</span><span class="o">;</span>
</span><span id="__span-0-72"><a id="__codelineno-0-72" name="__codelineno-0-72"></a>
</span><span id="__span-0-73"><a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="c1">// Free threads manually.</span>
</span><span id="__span-0-74"><a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="n">myThread</span><span class="o">.</span><span class="n">Free</span><span class="o">;</span>
</span><span id="__span-0-75"><a id="__codelineno-0-75" name="__codelineno-0-75"></a>
</span><span id="__span-0-76"><a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="c1">// Debug line.</span>
</span><span id="__span-0-77"><a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'We are in the main thread again'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-0-78"><a id="__codelineno-0-78" name="__codelineno-0-78"></a>
</span><span id="__span-0-79"><a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="c1">// Pause console.</span>
</span><span id="__span-0-80"><a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Press enter key to quit'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-0-81"><a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="nb">ReadLn</span><span class="o">;</span>
</span><span id="__span-0-82"><a id="__codelineno-0-82" name="__codelineno-0-82"></a>
</span><span id="__span-0-83"><a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="k">end</span><span class="o">.</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h2 id="run-same-tasks-on-multiple-threads">Run same tasks on multiple threads<a class="headerlink" href="#run-same-tasks-on-multiple-threads" title="Permanent link">¶</a></h2>
<div class="language-pascal highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">  1</a></span>
<span class="normal"><a href="#__codelineno-1-2">  2</a></span>
<span class="normal"><a href="#__codelineno-1-3">  3</a></span>
<span class="normal"><a href="#__codelineno-1-4">  4</a></span>
<span class="normal"><a href="#__codelineno-1-5">  5</a></span>
<span class="normal"><a href="#__codelineno-1-6">  6</a></span>
<span class="normal"><a href="#__codelineno-1-7">  7</a></span>
<span class="normal"><a href="#__codelineno-1-8">  8</a></span>
<span class="normal"><a href="#__codelineno-1-9">  9</a></span>
<span class="normal"><a href="#__codelineno-1-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-1-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-1-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-1-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-1-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-1-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-1-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-1-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-1-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-1-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-1-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-1-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-1-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-1-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-1-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-1-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-1-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-1-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-1-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-1-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-1-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-1-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-1-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-1-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-1-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-1-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-1-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-1-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-1-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-1-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-1-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-1-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-1-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-1-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-1-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-1-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-1-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-1-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-1-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-1-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-1-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-1-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-1-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-1-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-1-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-1-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-1-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-1-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-1-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-1-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-1-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-1-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-1-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-1-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-1-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-1-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-1-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-1-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-1-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-1-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-1-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-1-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-1-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-1-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-1-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-1-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-1-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-1-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-1-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-1-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-1-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-1-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-1-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-1-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-1-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-1-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-1-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-1-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-1-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-1-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-1-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-1-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-1-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-1-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-1-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-1-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-1-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-1-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-1-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-1-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-1-100">100</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="k">program</span><span class="w"> </span><span class="n">EX2MultiThread</span><span class="o">;</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="cm">{</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="cm">  # EX2MultiThread</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="cm">  A simple demo of multi-threading.</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="cm">  ## Example of an output</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="cm">  ---------------------</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="cm">  Started TThread demo</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="cm">  ---------------------</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="cm">  Starting a task from the main thread</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="cm">  Started a task on thread ID 22848</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="cm">  Started a task on thread ID 24428</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="cm">  Completed the task from the main thread</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="cm">  Completed task on thread ID: 22848</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="cm">  Completed task on thread ID: 24428</span>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="cm">  ---------------------</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="cm">  Finished TThread demo</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21"></a><span class="cm">  Press Enter to quit</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22"></a><span class="cm">  ---------------------</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23"></a><span class="cm">}</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24"></a>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25"></a>
</span><span id="__span-1-26"><a id="__codelineno-1-26" name="__codelineno-1-26"></a><span class="cm">{$mode objfpc}{$H+}{$J-}</span>
</span><span id="__span-1-27"><a id="__codelineno-1-27" name="__codelineno-1-27"></a>
</span><span id="__span-1-28"><a id="__codelineno-1-28" name="__codelineno-1-28"></a><span class="c1">// 2024-02-08 - paweld 🇵🇱 fixed a memory leak issue on the original code.</span>
</span><span id="__span-1-29"><a id="__codelineno-1-29" name="__codelineno-1-29"></a>
</span><span id="__span-1-30"><a id="__codelineno-1-30" name="__codelineno-1-30"></a><span class="k">uses</span>
</span><span id="__span-1-31"><a id="__codelineno-1-31" name="__codelineno-1-31"></a><span class="w">  </span><span class="cm">{$ifdef unix}</span>
</span><span id="__span-1-32"><a id="__codelineno-1-32" name="__codelineno-1-32"></a><span class="w">  </span><span class="n">cmem</span><span class="o">,</span><span class="w"> </span><span class="n">cthreads</span><span class="o">,</span>
</span><span id="__span-1-33"><a id="__codelineno-1-33" name="__codelineno-1-33"></a><span class="w">  </span><span class="cm">{$endif}</span>
</span><span id="__span-1-34"><a id="__codelineno-1-34" name="__codelineno-1-34"></a><span class="w">  </span><span class="n">Classes</span><span class="o">,</span>
</span><span id="__span-1-35"><a id="__codelineno-1-35" name="__codelineno-1-35"></a><span class="w">  </span><span class="n">SysUtils</span><span class="o">;</span>
</span><span id="__span-1-36"><a id="__codelineno-1-36" name="__codelineno-1-36"></a>
</span><span id="__span-1-37"><a id="__codelineno-1-37" name="__codelineno-1-37"></a><span class="k">type</span>
</span><span id="__span-1-38"><a id="__codelineno-1-38" name="__codelineno-1-38"></a><span class="w">  </span><span class="c1">// Create a class based on TThread</span>
</span><span id="__span-1-39"><a id="__codelineno-1-39" name="__codelineno-1-39"></a><span class="w">  </span><span class="c1">// TTaskThread</span>
</span><span id="__span-1-40"><a id="__codelineno-1-40" name="__codelineno-1-40"></a><span class="w">  </span><span class="n">TTaskThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">class</span><span class="p">(</span><span class="n">TThread</span><span class="p">)</span>
</span><span id="__span-1-41"><a id="__codelineno-1-41" name="__codelineno-1-41"></a><span class="w">  </span><span class="kp">protected</span>
</span><span id="__span-1-42"><a id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="w">    </span><span class="c1">// Override the Execute procedure of TThread</span>
</span><span id="__span-1-43"><a id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">Execute</span><span class="o">;</span><span class="w"> </span><span class="kp">override</span><span class="o">;</span>
</span><span id="__span-1-44"><a id="__codelineno-1-44" name="__codelineno-1-44"></a><span class="w">  </span><span class="kp">public</span>
</span><span id="__span-1-45"><a id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="w">    </span><span class="c1">// Thread constructor with free on terminate</span>
</span><span id="__span-1-46"><a id="__codelineno-1-46" name="__codelineno-1-46"></a><span class="w">    </span><span class="k">constructor</span><span class="w"> </span><span class="nf">Create</span><span class="o">;</span>
</span><span id="__span-1-47"><a id="__codelineno-1-47" name="__codelineno-1-47"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-1-48"><a id="__codelineno-1-48" name="__codelineno-1-48"></a>
</span><span id="__span-1-49"><a id="__codelineno-1-49" name="__codelineno-1-49"></a><span class="w">  </span><span class="c1">// The Execute procedure, simulating a task</span>
</span><span id="__span-1-50"><a id="__codelineno-1-50" name="__codelineno-1-50"></a><span class="w">  </span><span class="k">procedure</span><span class="w"> </span><span class="nc">TTaskThread</span><span class="o">.</span><span class="nf">Execute</span><span class="o">;</span>
</span><span id="__span-1-51"><a id="__codelineno-1-51" name="__codelineno-1-51"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-1-52"><a id="__codelineno-1-52" name="__codelineno-1-52"></a><span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Started a task on thread ID '</span><span class="o">,</span><span class="w"> </span><span class="n">ThreadID</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-1-53"><a id="__codelineno-1-53" name="__codelineno-1-53"></a>
</span><span id="__span-1-54"><a id="__codelineno-1-54" name="__codelineno-1-54"></a><span class="w">    </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span><span class="o">;</span><span class="w"> </span><span class="c1">// Simulating a long-running task.</span>
</span><span id="__span-1-55"><a id="__codelineno-1-55" name="__codelineno-1-55"></a>
</span><span id="__span-1-56"><a id="__codelineno-1-56" name="__codelineno-1-56"></a><span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Completed task on thread ID: '</span><span class="o">,</span><span class="w"> </span><span class="n">ThreadID</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-1-57"><a id="__codelineno-1-57" name="__codelineno-1-57"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-1-58"><a id="__codelineno-1-58" name="__codelineno-1-58"></a>
</span><span id="__span-1-59"><a id="__codelineno-1-59" name="__codelineno-1-59"></a><span class="w">  </span><span class="c1">// Constructor of TTaskThread</span>
</span><span id="__span-1-60"><a id="__codelineno-1-60" name="__codelineno-1-60"></a><span class="w">  </span><span class="k">constructor</span><span class="w"> </span><span class="nc">TTaskThread</span><span class="o">.</span><span class="nf">Create</span><span class="o">;</span>
</span><span id="__span-1-61"><a id="__codelineno-1-61" name="__codelineno-1-61"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-1-62"><a id="__codelineno-1-62" name="__codelineno-1-62"></a><span class="w">    </span><span class="c1">// Create as suspended.</span>
</span><span id="__span-1-63"><a id="__codelineno-1-63" name="__codelineno-1-63"></a><span class="w">    </span><span class="k">inherited</span><span class="w"> </span><span class="n">Create</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-1-64"><a id="__codelineno-1-64" name="__codelineno-1-64"></a><span class="w">    </span><span class="c1">// Set Free on Terminate to false, so it won't free itself when completed.</span>
</span><span id="__span-1-65"><a id="__codelineno-1-65" name="__codelineno-1-65"></a><span class="w">    </span><span class="n">FreeOnTerminate</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">False</span><span class="o">;</span>
</span><span id="__span-1-66"><a id="__codelineno-1-66" name="__codelineno-1-66"></a><span class="w">    </span><span class="c1">// Run thread.</span>
</span><span id="__span-1-67"><a id="__codelineno-1-67" name="__codelineno-1-67"></a><span class="w">    </span><span class="n">Start</span><span class="o">;</span>
</span><span id="__span-1-68"><a id="__codelineno-1-68" name="__codelineno-1-68"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-1-69"><a id="__codelineno-1-69" name="__codelineno-1-69"></a>
</span><span id="__span-1-70"><a id="__codelineno-1-70" name="__codelineno-1-70"></a><span class="k">var</span>
</span><span id="__span-1-71"><a id="__codelineno-1-71" name="__codelineno-1-71"></a><span class="w">  </span><span class="n">task1</span><span class="o">,</span><span class="w"> </span><span class="n">task2</span><span class="o">:</span><span class="w"> </span><span class="n">TThread</span><span class="o">;</span>
</span><span id="__span-1-72"><a id="__codelineno-1-72" name="__codelineno-1-72"></a>
</span><span id="__span-1-73"><a id="__codelineno-1-73" name="__codelineno-1-73"></a><span class="k">begin</span>
</span><span id="__span-1-74"><a id="__codelineno-1-74" name="__codelineno-1-74"></a><span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'---------------------'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-1-75"><a id="__codelineno-1-75" name="__codelineno-1-75"></a><span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Started TThread demo'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-1-76"><a id="__codelineno-1-76" name="__codelineno-1-76"></a><span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'---------------------'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-1-77"><a id="__codelineno-1-77" name="__codelineno-1-77"></a>
</span><span id="__span-1-78"><a id="__codelineno-1-78" name="__codelineno-1-78"></a><span class="w">  </span><span class="c1">// Create all threads</span>
</span><span id="__span-1-79"><a id="__codelineno-1-79" name="__codelineno-1-79"></a><span class="w">  </span><span class="n">task1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TTaskThread</span><span class="o">.</span><span class="n">Create</span><span class="o">;</span>
</span><span id="__span-1-80"><a id="__codelineno-1-80" name="__codelineno-1-80"></a><span class="w">  </span><span class="n">task2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TTaskThread</span><span class="o">.</span><span class="n">Create</span><span class="o">;</span>
</span><span id="__span-1-81"><a id="__codelineno-1-81" name="__codelineno-1-81"></a>
</span><span id="__span-1-82"><a id="__codelineno-1-82" name="__codelineno-1-82"></a><span class="w">  </span><span class="c1">// Start a task on the main thread</span>
</span><span id="__span-1-83"><a id="__codelineno-1-83" name="__codelineno-1-83"></a><span class="w">  </span><span class="nb">Writeln</span><span class="p">(</span><span class="s">'Starting a task from the main thread'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-1-84"><a id="__codelineno-1-84" name="__codelineno-1-84"></a><span class="w">  </span><span class="nb">Sleep</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span><span class="o">;</span><span class="w"> </span><span class="c1">// simulate a task</span>
</span><span id="__span-1-85"><a id="__codelineno-1-85" name="__codelineno-1-85"></a><span class="w">  </span><span class="nb">Writeln</span><span class="p">(</span><span class="s">'Completed the task from the main thread'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-1-86"><a id="__codelineno-1-86" name="__codelineno-1-86"></a>
</span><span id="__span-1-87"><a id="__codelineno-1-87" name="__codelineno-1-87"></a><span class="w">  </span><span class="c1">// Wait for threads to finish before going back to the main thread.</span>
</span><span id="__span-1-88"><a id="__codelineno-1-88" name="__codelineno-1-88"></a><span class="w">  </span><span class="n">task1</span><span class="o">.</span><span class="n">WaitFor</span><span class="o">;</span>
</span><span id="__span-1-89"><a id="__codelineno-1-89" name="__codelineno-1-89"></a><span class="w">  </span><span class="n">task2</span><span class="o">.</span><span class="n">WaitFor</span><span class="o">;</span>
</span><span id="__span-1-90"><a id="__codelineno-1-90" name="__codelineno-1-90"></a>
</span><span id="__span-1-91"><a id="__codelineno-1-91" name="__codelineno-1-91"></a><span class="w">  </span><span class="c1">// Free the threads manually</span>
</span><span id="__span-1-92"><a id="__codelineno-1-92" name="__codelineno-1-92"></a><span class="w">  </span><span class="n">task1</span><span class="o">.</span><span class="n">Free</span><span class="o">;</span>
</span><span id="__span-1-93"><a id="__codelineno-1-93" name="__codelineno-1-93"></a><span class="w">  </span><span class="n">task2</span><span class="o">.</span><span class="n">Free</span><span class="o">;</span>
</span><span id="__span-1-94"><a id="__codelineno-1-94" name="__codelineno-1-94"></a>
</span><span id="__span-1-95"><a id="__codelineno-1-95" name="__codelineno-1-95"></a><span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'---------------------'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-1-96"><a id="__codelineno-1-96" name="__codelineno-1-96"></a><span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Finished TThread demo'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-1-97"><a id="__codelineno-1-97" name="__codelineno-1-97"></a><span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Press Enter to quit'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-1-98"><a id="__codelineno-1-98" name="__codelineno-1-98"></a><span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'---------------------'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-1-99"><a id="__codelineno-1-99" name="__codelineno-1-99"></a><span class="w">  </span><span class="nb">ReadLn</span><span class="o">;</span>
</span><span id="__span-1-100"><a id="__codelineno-1-100" name="__codelineno-1-100"></a><span class="k">end</span><span class="o">.</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h2 id="sum-numbers-in-an-array">Sum numbers in an array<a class="headerlink" href="#sum-numbers-in-an-array" title="Permanent link">¶</a></h2>
<p>Important features of this example.</p>
<ol>
<li>Use of <code>TIntegerDynArray</code>, which is a dynamic array of integers.</li>
<li>Thread Class <code>TMyThread</code> inherits from <code>TThread</code>. This class encapsulates the logic for summing a segment of the array within each thread.</li>
<li>The constructor <code>TMyThread.Create</code> initialises the thread with the input array, start index, and end index. This setup ensures each thread works on a specific portion of the array.</li>
<li>The <code>Execute</code> method in <code>TMyThread</code> performs the actual summing of numbers within the assigned segment of the array.</li>
<li>Main program<ul>
<li>Calculates the segment size for each thread using <code>Math.Ceil((Length(inputArray) + MAX_THREADS - 1) / MAX_THREADS)</code>, ensuring that each thread gets an equal or almost equal portion of the array to process.</li>
<li>Creates and starts each thread, passing in the relevant segment of the array.</li>
<li>After all threads complete their work, collect the partial sums from each thread and calculate the total sum.</li>
</ul>
</li>
<li>Manual memory cleanup by setting <code>FreeOnTerminate := False</code> and manually freeing the threads after collecting their results.</li>
<li>Lastly, the program displays information about each thread's segment and its partial sum.</li>
</ol>
<div class="language-pascal highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">  1</a></span>
<span class="normal"><a href="#__codelineno-2-2">  2</a></span>
<span class="normal"><a href="#__codelineno-2-3">  3</a></span>
<span class="normal"><a href="#__codelineno-2-4">  4</a></span>
<span class="normal"><a href="#__codelineno-2-5">  5</a></span>
<span class="normal"><a href="#__codelineno-2-6">  6</a></span>
<span class="normal"><a href="#__codelineno-2-7">  7</a></span>
<span class="normal"><a href="#__codelineno-2-8">  8</a></span>
<span class="normal"><a href="#__codelineno-2-9">  9</a></span>
<span class="normal"><a href="#__codelineno-2-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-2-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-2-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-2-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-2-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-2-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-2-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-2-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-2-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-2-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-2-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-2-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-2-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-2-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-2-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-2-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-2-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-2-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-2-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-2-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-2-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-2-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-2-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-2-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-2-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-2-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-2-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-2-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-2-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-2-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-2-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-2-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-2-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-2-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-2-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-2-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-2-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-2-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-2-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-2-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-2-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-2-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-2-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-2-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-2-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-2-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-2-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-2-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-2-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-2-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-2-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-2-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-2-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-2-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-2-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-2-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-2-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-2-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-2-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-2-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-2-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-2-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-2-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-2-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-2-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-2-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-2-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-2-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-2-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-2-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-2-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-2-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-2-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-2-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-2-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-2-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-2-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-2-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-2-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-2-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-2-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-2-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-2-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-2-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-2-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-2-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-2-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-2-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-2-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-2-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-2-100">100</a></span>
<span class="normal"><a href="#__codelineno-2-101">101</a></span>
<span class="normal"><a href="#__codelineno-2-102">102</a></span>
<span class="normal"><a href="#__codelineno-2-103">103</a></span>
<span class="normal"><a href="#__codelineno-2-104">104</a></span>
<span class="normal"><a href="#__codelineno-2-105">105</a></span>
<span class="normal"><a href="#__codelineno-2-106">106</a></span>
<span class="normal"><a href="#__codelineno-2-107">107</a></span>
<span class="normal"><a href="#__codelineno-2-108">108</a></span>
<span class="normal"><a href="#__codelineno-2-109">109</a></span>
<span class="normal"><a href="#__codelineno-2-110">110</a></span>
<span class="normal"><a href="#__codelineno-2-111">111</a></span>
<span class="normal"><a href="#__codelineno-2-112">112</a></span>
<span class="normal"><a href="#__codelineno-2-113">113</a></span>
<span class="normal"><a href="#__codelineno-2-114">114</a></span>
<span class="normal"><a href="#__codelineno-2-115">115</a></span>
<span class="normal"><a href="#__codelineno-2-116">116</a></span>
<span class="normal"><a href="#__codelineno-2-117">117</a></span>
<span class="normal"><a href="#__codelineno-2-118">118</a></span>
<span class="normal"><a href="#__codelineno-2-119">119</a></span>
<span class="normal"><a href="#__codelineno-2-120">120</a></span>
<span class="normal"><a href="#__codelineno-2-121">121</a></span>
<span class="normal"><a href="#__codelineno-2-122">122</a></span>
<span class="normal"><a href="#__codelineno-2-123">123</a></span>
<span class="normal"><a href="#__codelineno-2-124">124</a></span>
<span class="normal"><a href="#__codelineno-2-125">125</a></span>
<span class="normal"><a href="#__codelineno-2-126">126</a></span>
<span class="normal"><a href="#__codelineno-2-127">127</a></span>
<span class="normal"><a href="#__codelineno-2-128">128</a></span>
<span class="normal"><a href="#__codelineno-2-129">129</a></span>
<span class="normal"><a href="#__codelineno-2-130">130</a></span>
<span class="normal"><a href="#__codelineno-2-131">131</a></span>
<span class="normal"><a href="#__codelineno-2-132">132</a></span>
<span class="normal"><a href="#__codelineno-2-133">133</a></span>
<span class="normal"><a href="#__codelineno-2-134">134</a></span>
<span class="normal"><a href="#__codelineno-2-135">135</a></span>
<span class="normal"><a href="#__codelineno-2-136">136</a></span>
<span class="normal"><a href="#__codelineno-2-137">137</a></span>
<span class="normal"><a href="#__codelineno-2-138">138</a></span>
<span class="normal"><a href="#__codelineno-2-139">139</a></span>
<span class="normal"><a href="#__codelineno-2-140">140</a></span>
<span class="normal"><a href="#__codelineno-2-141">141</a></span>
<span class="normal"><a href="#__codelineno-2-142">142</a></span>
<span class="normal"><a href="#__codelineno-2-143">143</a></span>
<span class="normal"><a href="#__codelineno-2-144">144</a></span>
<span class="normal"><a href="#__codelineno-2-145">145</a></span>
<span class="normal"><a href="#__codelineno-2-146">146</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="k">program</span><span class="w"> </span><span class="n">EX3MultiThread</span><span class="o">;</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="cm">{$mode objfpc}{$H+}{$J-}</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="k">uses</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="w">  </span><span class="cm">{$IFDEF UNIX}</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a><span class="w">  </span><span class="n">cmem</span><span class="o">,</span><span class="w"> </span><span class="n">cthreads</span><span class="o">,</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="w">  </span><span class="cm">{$ENDIF}</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="w">  </span><span class="n">Classes</span><span class="o">,</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">  </span><span class="n">Types</span><span class="o">,</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">  </span><span class="n">Generics</span><span class="o">.</span><span class="n">Collections</span><span class="o">,</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">  </span><span class="n">Math</span><span class="w"> </span><span class="cm">{ you can add units after this }</span><span class="o">;</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="w">  </span><span class="c1">// --- Custom thread type --------------------------------------</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15"></a><span class="k">type</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16"></a><span class="w">  </span><span class="c1">// The TThread class encapsulates the native thread support of the OS.</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17"></a><span class="w">  </span><span class="c1">// To create a thread, (1) declare a child of the TThread object, ...</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18"></a><span class="w">  </span><span class="n">TMyThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">class</span><span class="p">(</span><span class="n">TThread</span><span class="p">)</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19"></a><span class="w">    </span><span class="c1">// (with a data to work with)</span>
</span><span id="__span-2-20"><a id="__codelineno-2-20" name="__codelineno-2-20"></a><span class="w">  </span><span class="kp">private</span>
</span><span id="__span-2-21"><a id="__codelineno-2-21" name="__codelineno-2-21"></a><span class="w">    </span><span class="c1">// Variables to store the input array for this thread to sum, along with</span>
</span><span id="__span-2-22"><a id="__codelineno-2-22" name="__codelineno-2-22"></a><span class="w">    </span><span class="c1">// start index and end index</span>
</span><span id="__span-2-23"><a id="__codelineno-2-23" name="__codelineno-2-23"></a><span class="w">    </span><span class="n">anArray</span><span class="o">:</span><span class="w"> </span><span class="n">TIntegerDynArray</span><span class="o">;</span>
</span><span id="__span-2-24"><a id="__codelineno-2-24" name="__codelineno-2-24"></a><span class="w">    </span><span class="n">startIdx</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-2-25"><a id="__codelineno-2-25" name="__codelineno-2-25"></a><span class="w">    </span><span class="n">endIdx</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-2-26"><a id="__codelineno-2-26" name="__codelineno-2-26"></a><span class="w">    </span><span class="c1">// The sum of array in the thread</span>
</span><span id="__span-2-27"><a id="__codelineno-2-27" name="__codelineno-2-27"></a><span class="w">    </span><span class="n">partialSum</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-2-28"><a id="__codelineno-2-28" name="__codelineno-2-28"></a><span class="w">  </span><span class="kp">protected</span>
</span><span id="__span-2-29"><a id="__codelineno-2-29" name="__codelineno-2-29"></a><span class="w">    </span><span class="c1">// (2) override the Execute method, and ...</span>
</span><span id="__span-2-30"><a id="__codelineno-2-30" name="__codelineno-2-30"></a><span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">Execute</span><span class="o">;</span><span class="w"> </span><span class="kp">override</span><span class="o">;</span>
</span><span id="__span-2-31"><a id="__codelineno-2-31" name="__codelineno-2-31"></a><span class="w">  </span><span class="kp">public</span>
</span><span id="__span-2-32"><a id="__codelineno-2-32" name="__codelineno-2-32"></a><span class="w">    </span><span class="c1">// (3) lastly, you may include a constructor to setup variables</span>
</span><span id="__span-2-33"><a id="__codelineno-2-33" name="__codelineno-2-33"></a><span class="w">    </span><span class="c1">// for executing this thread.</span>
</span><span id="__span-2-34"><a id="__codelineno-2-34" name="__codelineno-2-34"></a><span class="w">    </span><span class="k">constructor</span><span class="w"> </span><span class="nf">Create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">isSuspended</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="o">;</span>
</span><span id="__span-2-35"><a id="__codelineno-2-35" name="__codelineno-2-35"></a><span class="w">                       </span><span class="k">var</span><span class="w">   </span><span class="n">inputArray</span><span class="o">:</span><span class="w"> </span><span class="n">TIntegerDynArray</span><span class="o">;</span>
</span><span id="__span-2-36"><a id="__codelineno-2-36" name="__codelineno-2-36"></a><span class="w">                       </span><span class="k">const</span><span class="w"> </span><span class="n">startIndex</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-2-37"><a id="__codelineno-2-37" name="__codelineno-2-37"></a><span class="w">                       </span><span class="k">const</span><span class="w"> </span><span class="n">endIndex</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-2-38"><a id="__codelineno-2-38" name="__codelineno-2-38"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-2-39"><a id="__codelineno-2-39" name="__codelineno-2-39"></a>
</span><span id="__span-2-40"><a id="__codelineno-2-40" name="__codelineno-2-40"></a><span class="w">  </span><span class="k">constructor</span><span class="w"> </span><span class="nc">TMyThread</span><span class="o">.</span><span class="nf">Create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">isSuspended</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="o">;</span>
</span><span id="__span-2-41"><a id="__codelineno-2-41" name="__codelineno-2-41"></a><span class="w">                               </span><span class="k">var</span><span class="w">   </span><span class="n">inputArray</span><span class="o">:</span><span class="w"> </span><span class="n">TIntegerDynArray</span><span class="o">;</span>
</span><span id="__span-2-42"><a id="__codelineno-2-42" name="__codelineno-2-42"></a><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">startIndex</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-2-43"><a id="__codelineno-2-43" name="__codelineno-2-43"></a><span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">endIndex</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-2-44"><a id="__codelineno-2-44" name="__codelineno-2-44"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-2-45"><a id="__codelineno-2-45" name="__codelineno-2-45"></a><span class="w">    </span><span class="c1">// Call parent's constructor</span>
</span><span id="__span-2-46"><a id="__codelineno-2-46" name="__codelineno-2-46"></a><span class="w">    </span><span class="c1">// If user pass True, thread won't start automatically</span>
</span><span id="__span-2-47"><a id="__codelineno-2-47" name="__codelineno-2-47"></a><span class="w">    </span><span class="k">inherited</span><span class="w"> </span><span class="n">Create</span><span class="p">(</span><span class="n">isSuspended</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-2-48"><a id="__codelineno-2-48" name="__codelineno-2-48"></a>
</span><span id="__span-2-49"><a id="__codelineno-2-49" name="__codelineno-2-49"></a><span class="w">    </span><span class="c1">// Assign a data to work with.</span>
</span><span id="__span-2-50"><a id="__codelineno-2-50" name="__codelineno-2-50"></a><span class="w">    </span><span class="k">self</span><span class="o">.</span><span class="n">anArray</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">inputArray</span><span class="o">;</span>
</span><span id="__span-2-51"><a id="__codelineno-2-51" name="__codelineno-2-51"></a><span class="w">    </span><span class="k">self</span><span class="o">.</span><span class="n">startIdx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">startIndex</span><span class="o">;</span>
</span><span id="__span-2-52"><a id="__codelineno-2-52" name="__codelineno-2-52"></a><span class="w">    </span><span class="k">self</span><span class="o">.</span><span class="n">endIdx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">endIndex</span><span class="o">;</span>
</span><span id="__span-2-53"><a id="__codelineno-2-53" name="__codelineno-2-53"></a>
</span><span id="__span-2-54"><a id="__codelineno-2-54" name="__codelineno-2-54"></a><span class="w">    </span><span class="c1">// DO NOT Free thread when finished here.</span>
</span><span id="__span-2-55"><a id="__codelineno-2-55" name="__codelineno-2-55"></a><span class="w">    </span><span class="c1">// The main thread will ...</span>
</span><span id="__span-2-56"><a id="__codelineno-2-56" name="__codelineno-2-56"></a><span class="w">    </span><span class="c1">//   1. collect the results from n threads,</span>
</span><span id="__span-2-57"><a id="__codelineno-2-57" name="__codelineno-2-57"></a><span class="w">    </span><span class="c1">//   2. free n threads from the main thread.</span>
</span><span id="__span-2-58"><a id="__codelineno-2-58" name="__codelineno-2-58"></a><span class="w">    </span><span class="n">FreeOnTerminate</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">False</span><span class="o">;</span>
</span><span id="__span-2-59"><a id="__codelineno-2-59" name="__codelineno-2-59"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-2-60"><a id="__codelineno-2-60" name="__codelineno-2-60"></a>
</span><span id="__span-2-61"><a id="__codelineno-2-61" name="__codelineno-2-61"></a><span class="w">  </span><span class="k">procedure</span><span class="w"> </span><span class="nc">TMyThread</span><span class="o">.</span><span class="nf">Execute</span><span class="o">;</span>
</span><span id="__span-2-62"><a id="__codelineno-2-62" name="__codelineno-2-62"></a><span class="w">  </span><span class="k">var</span>
</span><span id="__span-2-63"><a id="__codelineno-2-63" name="__codelineno-2-63"></a><span class="w">    </span><span class="kp">index</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-2-64"><a id="__codelineno-2-64" name="__codelineno-2-64"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-2-65"><a id="__codelineno-2-65" name="__codelineno-2-65"></a><span class="w">    </span><span class="c1">// Execute thread, and DO SOMETHING in this thread.</span>
</span><span id="__span-2-66"><a id="__codelineno-2-66" name="__codelineno-2-66"></a>
</span><span id="__span-2-67"><a id="__codelineno-2-67" name="__codelineno-2-67"></a><span class="w">    </span><span class="c1">// Initialise partialSum to 0 to start with</span>
</span><span id="__span-2-68"><a id="__codelineno-2-68" name="__codelineno-2-68"></a><span class="w">    </span><span class="k">self</span><span class="o">.</span><span class="n">partialSum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
</span><span id="__span-2-69"><a id="__codelineno-2-69" name="__codelineno-2-69"></a>
</span><span id="__span-2-70"><a id="__codelineno-2-70" name="__codelineno-2-70"></a><span class="w">    </span><span class="c1">// partialSum the numbers in the assigned array using for..do loop.</span>
</span><span id="__span-2-71"><a id="__codelineno-2-71" name="__codelineno-2-71"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">self</span><span class="o">.</span><span class="n">startIdx</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">self</span><span class="o">.</span><span class="n">endIdx</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-2-72"><a id="__codelineno-2-72" name="__codelineno-2-72"></a><span class="w">      </span><span class="k">self</span><span class="o">.</span><span class="n">partialSum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">self</span><span class="o">.</span><span class="n">partialSum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">self</span><span class="o">.</span><span class="n">anArray</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">;</span>
</span><span id="__span-2-73"><a id="__codelineno-2-73" name="__codelineno-2-73"></a>
</span><span id="__span-2-74"><a id="__codelineno-2-74" name="__codelineno-2-74"></a><span class="w">    </span><span class="c1">// Display user feedback from this thread</span>
</span><span id="__span-2-75"><a id="__codelineno-2-75" name="__codelineno-2-75"></a><span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Thread '</span><span class="o">,</span><span class="w"> </span><span class="n">ThreadID</span><span class="o">,</span><span class="w"> </span><span class="s">' summed up '</span><span class="o">,</span><span class="w"> </span><span class="k">self</span><span class="o">.</span><span class="n">partialSum</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-2-76"><a id="__codelineno-2-76" name="__codelineno-2-76"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-2-77"><a id="__codelineno-2-77" name="__codelineno-2-77"></a>
</span><span id="__span-2-78"><a id="__codelineno-2-78" name="__codelineno-2-78"></a><span class="c1">// const and var for the main block ----------------------------</span>
</span><span id="__span-2-79"><a id="__codelineno-2-79" name="__codelineno-2-79"></a><span class="k">const</span>
</span><span id="__span-2-80"><a id="__codelineno-2-80" name="__codelineno-2-80"></a><span class="w">  </span><span class="c1">// Specify max number of threads to use.</span>
</span><span id="__span-2-81"><a id="__codelineno-2-81" name="__codelineno-2-81"></a><span class="w">  </span><span class="n">MAX_THREADS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="o">;</span>
</span><span id="__span-2-82"><a id="__codelineno-2-82" name="__codelineno-2-82"></a><span class="w">  </span><span class="c1">// The length of an input array may come from a file.</span>
</span><span id="__span-2-83"><a id="__codelineno-2-83" name="__codelineno-2-83"></a><span class="w">  </span><span class="n">INPUT_ARRAY_LENGTH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000</span><span class="o">;</span>
</span><span id="__span-2-84"><a id="__codelineno-2-84" name="__codelineno-2-84"></a>
</span><span id="__span-2-85"><a id="__codelineno-2-85" name="__codelineno-2-85"></a><span class="k">var</span>
</span><span id="__span-2-86"><a id="__codelineno-2-86" name="__codelineno-2-86"></a><span class="w">  </span><span class="c1">// Input array containg numbers to sum.</span>
</span><span id="__span-2-87"><a id="__codelineno-2-87" name="__codelineno-2-87"></a><span class="w">  </span><span class="n">inputArray</span><span class="o">:</span><span class="w"> </span><span class="n">TIntegerDynArray</span><span class="o">;</span>
</span><span id="__span-2-88"><a id="__codelineno-2-88" name="__codelineno-2-88"></a><span class="w">  </span><span class="c1">// Setting an array for the threads.</span>
</span><span id="__span-2-89"><a id="__codelineno-2-89" name="__codelineno-2-89"></a><span class="w">  </span><span class="n">myThreads</span><span class="o">:</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">TMyThread</span><span class="o">;</span>
</span><span id="__span-2-90"><a id="__codelineno-2-90" name="__codelineno-2-90"></a><span class="w">  </span><span class="c1">// Size of a segment for each thread</span>
</span><span id="__span-2-91"><a id="__codelineno-2-91" name="__codelineno-2-91"></a><span class="w">  </span><span class="n">segmentSize</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-2-92"><a id="__codelineno-2-92" name="__codelineno-2-92"></a><span class="w">  </span><span class="c1">// total sum -- will collect values from each thread</span>
</span><span id="__span-2-93"><a id="__codelineno-2-93" name="__codelineno-2-93"></a><span class="w">  </span><span class="n">totalSum</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-2-94"><a id="__codelineno-2-94" name="__codelineno-2-94"></a><span class="w">  </span><span class="c1">// Indexes</span>
</span><span id="__span-2-95"><a id="__codelineno-2-95" name="__codelineno-2-95"></a><span class="w">  </span><span class="kp">index</span><span class="o">,</span><span class="w"> </span><span class="n">startIndex</span><span class="o">,</span><span class="w"> </span><span class="n">endIndex</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-2-96"><a id="__codelineno-2-96" name="__codelineno-2-96"></a>
</span><span id="__span-2-97"><a id="__codelineno-2-97" name="__codelineno-2-97"></a>
</span><span id="__span-2-98"><a id="__codelineno-2-98" name="__codelineno-2-98"></a><span class="w">  </span><span class="c1">// Main block ------------------------------------------------</span>
</span><span id="__span-2-99"><a id="__codelineno-2-99" name="__codelineno-2-99"></a><span class="k">begin</span>
</span><span id="__span-2-100"><a id="__codelineno-2-100" name="__codelineno-2-100"></a>
</span><span id="__span-2-101"><a id="__codelineno-2-101" name="__codelineno-2-101"></a><span class="w">  </span><span class="c1">// Populate input array. This may come from a file.</span>
</span><span id="__span-2-102"><a id="__codelineno-2-102" name="__codelineno-2-102"></a><span class="w">  </span><span class="nb">SetLength</span><span class="p">(</span><span class="n">inputArray</span><span class="o">,</span><span class="w"> </span><span class="n">INPUT_ARRAY_LENGTH</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-2-103"><a id="__codelineno-2-103" name="__codelineno-2-103"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">INPUT_ARRAY_LENGTH</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-2-104"><a id="__codelineno-2-104" name="__codelineno-2-104"></a><span class="w">    </span><span class="n">inputArray</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="o">;</span>
</span><span id="__span-2-105"><a id="__codelineno-2-105" name="__codelineno-2-105"></a>
</span><span id="__span-2-106"><a id="__codelineno-2-106" name="__codelineno-2-106"></a>
</span><span id="__span-2-107"><a id="__codelineno-2-107" name="__codelineno-2-107"></a><span class="w">  </span><span class="c1">// Calculate segment size for each thread</span>
</span><span id="__span-2-108"><a id="__codelineno-2-108" name="__codelineno-2-108"></a><span class="w">  </span><span class="n">segmentSize</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">Math</span><span class="o">.</span><span class="n">Ceil</span><span class="p">((</span><span class="nb">Length</span><span class="p">(</span><span class="n">inputArray</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">MAX_THREADS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">MAX_THREADS</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-2-109"><a id="__codelineno-2-109" name="__codelineno-2-109"></a>
</span><span id="__span-2-110"><a id="__codelineno-2-110" name="__codelineno-2-110"></a><span class="w">  </span><span class="c1">// Create and start the threads.</span>
</span><span id="__span-2-111"><a id="__codelineno-2-111" name="__codelineno-2-111"></a><span class="w">  </span><span class="nb">SetLength</span><span class="p">(</span><span class="n">myThreads</span><span class="o">,</span><span class="w"> </span><span class="n">MAX_THREADS</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-2-112"><a id="__codelineno-2-112" name="__codelineno-2-112"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">MAX_THREADS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-2-113"><a id="__codelineno-2-113" name="__codelineno-2-113"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-2-114"><a id="__codelineno-2-114" name="__codelineno-2-114"></a><span class="w">    </span><span class="c1">// Start index for a thread is i * segmentSize.</span>
</span><span id="__span-2-115"><a id="__codelineno-2-115" name="__codelineno-2-115"></a><span class="w">    </span><span class="n">startIndex</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SegmentSize</span><span class="o">;</span>
</span><span id="__span-2-116"><a id="__codelineno-2-116" name="__codelineno-2-116"></a><span class="w">    </span><span class="c1">// Ensure that each thread processes the correct portion of the array</span>
</span><span id="__span-2-117"><a id="__codelineno-2-117" name="__codelineno-2-117"></a><span class="w">    </span><span class="c1">// without going out of bounds on last iteration.</span>
</span><span id="__span-2-118"><a id="__codelineno-2-118" name="__codelineno-2-118"></a><span class="w">    </span><span class="n">endIndex</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Min</span><span class="p">((</span><span class="kp">index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">SegmentSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="nb">Length</span><span class="p">(</span><span class="n">inputArray</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-2-119"><a id="__codelineno-2-119" name="__codelineno-2-119"></a>
</span><span id="__span-2-120"><a id="__codelineno-2-120" name="__codelineno-2-120"></a><span class="w">    </span><span class="c1">// Show user info.</span>
</span><span id="__span-2-121"><a id="__codelineno-2-121" name="__codelineno-2-121"></a><span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'startIndex: '</span><span class="o">,</span><span class="w"> </span><span class="n">startIndex</span><span class="o">,</span><span class="w"> </span><span class="s">' '</span><span class="o">,</span><span class="w"> </span><span class="s">' endIndex:'</span><span class="o">,</span><span class="w"> </span><span class="n">endIndex</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-2-122"><a id="__codelineno-2-122" name="__codelineno-2-122"></a>
</span><span id="__span-2-123"><a id="__codelineno-2-123" name="__codelineno-2-123"></a><span class="w">    </span><span class="c1">// Create a thread.</span>
</span><span id="__span-2-124"><a id="__codelineno-2-124" name="__codelineno-2-124"></a><span class="w">    </span><span class="n">myThreads</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TMyThread</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="k">False</span><span class="o">,</span><span class="w"> </span><span class="n">inputArray</span><span class="o">,</span><span class="w"> </span><span class="n">StartIndex</span><span class="o">,</span><span class="w"> </span><span class="n">EndIndex</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-2-125"><a id="__codelineno-2-125" name="__codelineno-2-125"></a><span class="w">    </span><span class="c1">// Start this new thread.</span>
</span><span id="__span-2-126"><a id="__codelineno-2-126" name="__codelineno-2-126"></a><span class="w">    </span><span class="n">myThreads</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">.</span><span class="n">Start</span><span class="o">;</span>
</span><span id="__span-2-127"><a id="__codelineno-2-127" name="__codelineno-2-127"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-2-128"><a id="__codelineno-2-128" name="__codelineno-2-128"></a>
</span><span id="__span-2-129"><a id="__codelineno-2-129" name="__codelineno-2-129"></a><span class="w">  </span><span class="c1">// Wait until a thread is done, sum up and free it.</span>
</span><span id="__span-2-130"><a id="__codelineno-2-130" name="__codelineno-2-130"></a><span class="w">  </span><span class="n">totalSum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
</span><span id="__span-2-131"><a id="__codelineno-2-131" name="__codelineno-2-131"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">MAX_THREADS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-2-132"><a id="__codelineno-2-132" name="__codelineno-2-132"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-2-133"><a id="__codelineno-2-133" name="__codelineno-2-133"></a><span class="w">    </span><span class="c1">// Wait until thread index n finishes</span>
</span><span id="__span-2-134"><a id="__codelineno-2-134" name="__codelineno-2-134"></a><span class="w">    </span><span class="n">myThreads</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">.</span><span class="n">WaitFor</span><span class="o">;</span>
</span><span id="__span-2-135"><a id="__codelineno-2-135" name="__codelineno-2-135"></a><span class="w">    </span><span class="c1">// Get the partial sum from thread index n</span>
</span><span id="__span-2-136"><a id="__codelineno-2-136" name="__codelineno-2-136"></a><span class="w">    </span><span class="n">totalSum</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">totalSum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">myThreads</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">.</span><span class="n">partialSum</span><span class="o">;</span>
</span><span id="__span-2-137"><a id="__codelineno-2-137" name="__codelineno-2-137"></a><span class="w">    </span><span class="c1">// Lastly, free thread index n</span>
</span><span id="__span-2-138"><a id="__codelineno-2-138" name="__codelineno-2-138"></a><span class="w">    </span><span class="n">myThreads</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">.</span><span class="n">Free</span><span class="o">;</span>
</span><span id="__span-2-139"><a id="__codelineno-2-139" name="__codelineno-2-139"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-2-140"><a id="__codelineno-2-140" name="__codelineno-2-140"></a>
</span><span id="__span-2-141"><a id="__codelineno-2-141" name="__codelineno-2-141"></a><span class="w">  </span><span class="c1">// Display results</span>
</span><span id="__span-2-142"><a id="__codelineno-2-142" name="__codelineno-2-142"></a><span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Total sum of array is: '</span><span class="o">,</span><span class="w"> </span><span class="n">totalSum</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-2-143"><a id="__codelineno-2-143" name="__codelineno-2-143"></a>
</span><span id="__span-2-144"><a id="__codelineno-2-144" name="__codelineno-2-144"></a><span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Press enter key to quit'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-2-145"><a id="__codelineno-2-145" name="__codelineno-2-145"></a><span class="w">  </span><span class="nb">ReadLn</span><span class="o">;</span>
</span><span id="__span-2-146"><a id="__codelineno-2-146" name="__codelineno-2-146"></a><span class="k">end</span><span class="o">.</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h2 id="increment-a-counter-multi-threading">Increment a counter multi-threading<a class="headerlink" href="#increment-a-counter-multi-threading" title="Permanent link">¶</a></h2>
<p>This snippet features:</p>
<ul>
<li>Use of <code>TRTLCriticalSection</code> to ensure only one thread can increment a counter variable</li>
</ul>
<div class="language-pascal highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="k">program</span><span class="w"> </span><span class="n">CriticalSectionIncrementCounter</span><span class="o">;</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="cm">{</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="cm">  An example adapted from \lazarus\examples\multithreading\multithread_critical</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="cm">  for CLI.</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="cm">  This is a simple example using 4 threads to increase a counter (shared</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="cm">  variable).</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="cm">  To enable critical sections, set isCriticalSectionEnabled to True.</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="cm">  To disable critical sections, set isCriticalSectionEnabled to False.</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="cm">  With critical sections you will always get 4,000,000.</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="cm">  Without you will see different results on each run.</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a>
</span><span id="__span-3-16"><a id="__codelineno-3-16" name="__codelineno-3-16" href="#__codelineno-3-16"></a><span class="cm">  Important: In most Unix like systems, the cthread unit must be added</span>
</span><span id="__span-3-17"><a id="__codelineno-3-17" name="__codelineno-3-17" href="#__codelineno-3-17"></a><span class="cm">             to the uses section of the .lpr file. Further, cmem is likely to</span>
</span><span id="__span-3-18"><a id="__codelineno-3-18" name="__codelineno-3-18" href="#__codelineno-3-18"></a><span class="cm">             be significently faster so add it as well. Due to how the units</span>
</span><span id="__span-3-19"><a id="__codelineno-3-19" name="__codelineno-3-19" href="#__codelineno-3-19"></a><span class="cm">             work a sensible order is cmem, cthreads and then perhaps cwstrings.</span>
</span><span id="__span-3-20"><a id="__codelineno-3-20" name="__codelineno-3-20" href="#__codelineno-3-20"></a><span class="cm">             But note that heaptrc does not work with cmem so comment it out</span>
</span><span id="__span-3-21"><a id="__codelineno-3-21" name="__codelineno-3-21" href="#__codelineno-3-21"></a><span class="cm">             while testing/debugging.</span>
</span><span id="__span-3-22"><a id="__codelineno-3-22" name="__codelineno-3-22" href="#__codelineno-3-22"></a><span class="cm">}</span>
</span><span id="__span-3-23"><a id="__codelineno-3-23" name="__codelineno-3-23" href="#__codelineno-3-23"></a>
</span><span id="__span-3-24"><a id="__codelineno-3-24" name="__codelineno-3-24" href="#__codelineno-3-24"></a><span class="cm">{$mode objfpc}{$H+}{$J-}</span>
</span><span id="__span-3-25"><a id="__codelineno-3-25" name="__codelineno-3-25" href="#__codelineno-3-25"></a>
</span><span id="__span-3-26"><a id="__codelineno-3-26" name="__codelineno-3-26" href="#__codelineno-3-26"></a><span class="k">uses</span>
</span><span id="__span-3-27"><a id="__codelineno-3-27" name="__codelineno-3-27" href="#__codelineno-3-27"></a><span class="w">  </span><span class="cm">{$IFDEF UNIX}</span>
</span><span id="__span-3-28"><a id="__codelineno-3-28" name="__codelineno-3-28" href="#__codelineno-3-28"></a><span class="w">  </span><span class="n">cmem</span><span class="o">,</span><span class="w"> </span><span class="n">cthreads</span><span class="o">,</span>
</span><span id="__span-3-29"><a id="__codelineno-3-29" name="__codelineno-3-29" href="#__codelineno-3-29"></a><span class="w">  </span><span class="cm">{$ENDIF}</span>
</span><span id="__span-3-30"><a id="__codelineno-3-30" name="__codelineno-3-30" href="#__codelineno-3-30"></a><span class="w">  </span><span class="n">Classes</span><span class="o">,</span>
</span><span id="__span-3-31"><a id="__codelineno-3-31" name="__codelineno-3-31" href="#__codelineno-3-31"></a><span class="w">  </span><span class="n">SysUtils</span><span class="o">;</span>
</span><span id="__span-3-32"><a id="__codelineno-3-32" name="__codelineno-3-32" href="#__codelineno-3-32"></a>
</span><span id="__span-3-33"><a id="__codelineno-3-33" name="__codelineno-3-33" href="#__codelineno-3-33"></a><span class="k">type</span>
</span><span id="__span-3-34"><a id="__codelineno-3-34" name="__codelineno-3-34" href="#__codelineno-3-34"></a><span class="w">  </span><span class="n">TCustomThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">class</span><span class="p">(</span><span class="n">TTHread</span><span class="p">)</span>
</span><span id="__span-3-35"><a id="__codelineno-3-35" name="__codelineno-3-35" href="#__codelineno-3-35"></a><span class="w">  </span><span class="kp">private</span>
</span><span id="__span-3-36"><a id="__codelineno-3-36" name="__codelineno-3-36" href="#__codelineno-3-36"></a><span class="w">    </span><span class="n">finishedState</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="o">;</span>
</span><span id="__span-3-37"><a id="__codelineno-3-37" name="__codelineno-3-37" href="#__codelineno-3-37"></a><span class="w">  </span><span class="kp">public</span>
</span><span id="__span-3-38"><a id="__codelineno-3-38" name="__codelineno-3-38" href="#__codelineno-3-38"></a><span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">Execute</span><span class="o">;</span><span class="w"> </span><span class="kp">override</span><span class="o">;</span>
</span><span id="__span-3-39"><a id="__codelineno-3-39" name="__codelineno-3-39" href="#__codelineno-3-39"></a><span class="w">    </span><span class="k">property</span><span class="w"> </span><span class="py">isFinished</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="kp">read</span><span class="w"> </span><span class="nf">finishedState</span><span class="w"> </span><span class="kp">write</span><span class="w"> </span><span class="nf">finishedState</span><span class="o">;</span>
</span><span id="__span-3-40"><a id="__codelineno-3-40" name="__codelineno-3-40" href="#__codelineno-3-40"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-3-41"><a id="__codelineno-3-41" name="__codelineno-3-41" href="#__codelineno-3-41"></a>
</span><span id="__span-3-42"><a id="__codelineno-3-42" name="__codelineno-3-42" href="#__codelineno-3-42"></a><span class="k">const</span>
</span><span id="__span-3-43"><a id="__codelineno-3-43" name="__codelineno-3-43" href="#__codelineno-3-43"></a><span class="w">  </span><span class="c1">// Use Critical Section or not?</span>
</span><span id="__span-3-44"><a id="__codelineno-3-44" name="__codelineno-3-44" href="#__codelineno-3-44"></a><span class="w">  </span><span class="n">isCriticalSectionEnabled</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="o">;</span>
</span><span id="__span-3-45"><a id="__codelineno-3-45" name="__codelineno-3-45" href="#__codelineno-3-45"></a>
</span><span id="__span-3-46"><a id="__codelineno-3-46" name="__codelineno-3-46" href="#__codelineno-3-46"></a><span class="k">var</span>
</span><span id="__span-3-47"><a id="__codelineno-3-47" name="__codelineno-3-47" href="#__codelineno-3-47"></a><span class="w">  </span><span class="n">criticalSection</span><span class="o">:</span><span class="w"> </span><span class="n">TRTLCriticalSection</span><span class="o">;</span>
</span><span id="__span-3-48"><a id="__codelineno-3-48" name="__codelineno-3-48" href="#__codelineno-3-48"></a><span class="w">  </span><span class="n">mainCounter</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-3-49"><a id="__codelineno-3-49" name="__codelineno-3-49" href="#__codelineno-3-49"></a>
</span><span id="__span-3-50"><a id="__codelineno-3-50" name="__codelineno-3-50" href="#__codelineno-3-50"></a><span class="w">  </span><span class="k">procedure</span><span class="w"> </span><span class="nc">TCustomThread</span><span class="o">.</span><span class="nf">Execute</span><span class="o">;</span>
</span><span id="__span-3-51"><a id="__codelineno-3-51" name="__codelineno-3-51" href="#__codelineno-3-51"></a><span class="w">  </span><span class="k">var</span>
</span><span id="__span-3-52"><a id="__codelineno-3-52" name="__codelineno-3-52" href="#__codelineno-3-52"></a><span class="w">    </span><span class="n">i</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-3-53"><a id="__codelineno-3-53" name="__codelineno-3-53" href="#__codelineno-3-53"></a><span class="w">    </span><span class="n">currentCounter</span><span class="o">:</span><span class="w"> </span><span class="kt">longint</span><span class="o">;</span>
</span><span id="__span-3-54"><a id="__codelineno-3-54" name="__codelineno-3-54" href="#__codelineno-3-54"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-3-55"><a id="__codelineno-3-55" name="__codelineno-3-55" href="#__codelineno-3-55"></a><span class="w">    </span><span class="c1">// Set the finished state to false.</span>
</span><span id="__span-3-56"><a id="__codelineno-3-56" name="__codelineno-3-56" href="#__codelineno-3-56"></a><span class="w">    </span><span class="n">finishedState</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">False</span><span class="o">;</span>
</span><span id="__span-3-57"><a id="__codelineno-3-57" name="__codelineno-3-57" href="#__codelineno-3-57"></a>
</span><span id="__span-3-58"><a id="__codelineno-3-58" name="__codelineno-3-58" href="#__codelineno-3-58"></a><span class="w">    </span><span class="c1">// Increment the mainCounter.</span>
</span><span id="__span-3-59"><a id="__codelineno-3-59" name="__codelineno-3-59" href="#__codelineno-3-59"></a><span class="w">    </span><span class="c1">// Because the other threads are doing the same, it will frequently happen</span>
</span><span id="__span-3-60"><a id="__codelineno-3-60" name="__codelineno-3-60" href="#__codelineno-3-60"></a><span class="w">    </span><span class="c1">// that 2 (or more) threads read the same number, increment it by one and</span>
</span><span id="__span-3-61"><a id="__codelineno-3-61" name="__codelineno-3-61" href="#__codelineno-3-61"></a><span class="w">    </span><span class="c1">// write the result back, overwriting the result of the other threads.</span>
</span><span id="__span-3-62"><a id="__codelineno-3-62" name="__codelineno-3-62" href="#__codelineno-3-62"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="mi">1000000</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-3-63"><a id="__codelineno-3-63" name="__codelineno-3-63" href="#__codelineno-3-63"></a><span class="w">    </span><span class="k">begin</span>
</span><span id="__span-3-64"><a id="__codelineno-3-64" name="__codelineno-3-64" href="#__codelineno-3-64"></a>
</span><span id="__span-3-65"><a id="__codelineno-3-65" name="__codelineno-3-65" href="#__codelineno-3-65"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">isCriticalSectionEnabled</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-3-66"><a id="__codelineno-3-66" name="__codelineno-3-66" href="#__codelineno-3-66"></a><span class="w">        </span><span class="c1">// 2. Begins the lock.</span>
</span><span id="__span-3-67"><a id="__codelineno-3-67" name="__codelineno-3-67" href="#__codelineno-3-67"></a><span class="w">        </span><span class="c1">//    When this call returns, the calling thread is the only thread</span>
</span><span id="__span-3-68"><a id="__codelineno-3-68" name="__codelineno-3-68" href="#__codelineno-3-68"></a><span class="w">        </span><span class="c1">//    running the code between the EnterCriticalSection call and the</span>
</span><span id="__span-3-69"><a id="__codelineno-3-69" name="__codelineno-3-69" href="#__codelineno-3-69"></a><span class="w">        </span><span class="c1">//    following LeaveCriticalsection call.</span>
</span><span id="__span-3-70"><a id="__codelineno-3-70" name="__codelineno-3-70" href="#__codelineno-3-70"></a><span class="w">        </span><span class="n">EnterCriticalSection</span><span class="p">(</span><span class="n">criticalSection</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-3-71"><a id="__codelineno-3-71" name="__codelineno-3-71" href="#__codelineno-3-71"></a><span class="w">      </span><span class="k">try</span>
</span><span id="__span-3-72"><a id="__codelineno-3-72" name="__codelineno-3-72" href="#__codelineno-3-72"></a><span class="w">        </span><span class="c1">// Read the current mainCounter</span>
</span><span id="__span-3-73"><a id="__codelineno-3-73" name="__codelineno-3-73" href="#__codelineno-3-73"></a><span class="w">        </span><span class="n">currentCounter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">mainCounter</span><span class="o">;</span>
</span><span id="__span-3-74"><a id="__codelineno-3-74" name="__codelineno-3-74" href="#__codelineno-3-74"></a><span class="w">        </span><span class="c1">// Increment mainCounter by one</span>
</span><span id="__span-3-75"><a id="__codelineno-3-75" name="__codelineno-3-75" href="#__codelineno-3-75"></a><span class="w">        </span><span class="nb">Inc</span><span class="p">(</span><span class="n">currentCounter</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-3-76"><a id="__codelineno-3-76" name="__codelineno-3-76" href="#__codelineno-3-76"></a><span class="w">        </span><span class="c1">// Write the result back the mainCounter variable</span>
</span><span id="__span-3-77"><a id="__codelineno-3-77" name="__codelineno-3-77" href="#__codelineno-3-77"></a><span class="w">        </span><span class="n">mainCounter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">currentCounter</span><span class="o">;</span>
</span><span id="__span-3-78"><a id="__codelineno-3-78" name="__codelineno-3-78" href="#__codelineno-3-78"></a><span class="w">      </span><span class="k">finally</span>
</span><span id="__span-3-79"><a id="__codelineno-3-79" name="__codelineno-3-79" href="#__codelineno-3-79"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">isCriticalSectionEnabled</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-3-80"><a id="__codelineno-3-80" name="__codelineno-3-80" href="#__codelineno-3-80"></a><span class="w">          </span><span class="c1">// 3. Releases the lock.</span>
</span><span id="__span-3-81"><a id="__codelineno-3-81" name="__codelineno-3-81" href="#__codelineno-3-81"></a><span class="w">          </span><span class="c1">//    Signals that the protected code can be executed by other threads.</span>
</span><span id="__span-3-82"><a id="__codelineno-3-82" name="__codelineno-3-82" href="#__codelineno-3-82"></a><span class="w">          </span><span class="n">LeaveCriticalSection</span><span class="p">(</span><span class="n">criticalSection</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-3-83"><a id="__codelineno-3-83" name="__codelineno-3-83" href="#__codelineno-3-83"></a><span class="w">      </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-3-84"><a id="__codelineno-3-84" name="__codelineno-3-84" href="#__codelineno-3-84"></a><span class="w">    </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-3-85"><a id="__codelineno-3-85" name="__codelineno-3-85" href="#__codelineno-3-85"></a>
</span><span id="__span-3-86"><a id="__codelineno-3-86" name="__codelineno-3-86" href="#__codelineno-3-86"></a><span class="w">    </span><span class="c1">// Once the task for this thread is done, set the finished state to True.</span>
</span><span id="__span-3-87"><a id="__codelineno-3-87" name="__codelineno-3-87" href="#__codelineno-3-87"></a><span class="w">    </span><span class="n">finishedState</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">True</span><span class="o">;</span>
</span><span id="__span-3-88"><a id="__codelineno-3-88" name="__codelineno-3-88" href="#__codelineno-3-88"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-3-89"><a id="__codelineno-3-89" name="__codelineno-3-89" href="#__codelineno-3-89"></a>
</span><span id="__span-3-90"><a id="__codelineno-3-90" name="__codelineno-3-90" href="#__codelineno-3-90"></a><span class="w">  </span><span class="cm">{</span>
</span><span id="__span-3-91"><a id="__codelineno-3-91" name="__codelineno-3-91" href="#__codelineno-3-91"></a><span class="cm">   This is the routine that increment a counter</span>
</span><span id="__span-3-92"><a id="__codelineno-3-92" name="__codelineno-3-92" href="#__codelineno-3-92"></a><span class="cm">  }</span>
</span><span id="__span-3-93"><a id="__codelineno-3-93" name="__codelineno-3-93" href="#__codelineno-3-93"></a><span class="w">  </span><span class="k">procedure</span><span class="w"> </span><span class="nf">IncrementCounter</span><span class="o">;</span>
</span><span id="__span-3-94"><a id="__codelineno-3-94" name="__codelineno-3-94" href="#__codelineno-3-94"></a><span class="w">  </span><span class="k">var</span>
</span><span id="__span-3-95"><a id="__codelineno-3-95" name="__codelineno-3-95" href="#__codelineno-3-95"></a><span class="w">    </span><span class="kp">index</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-3-96"><a id="__codelineno-3-96" name="__codelineno-3-96" href="#__codelineno-3-96"></a><span class="w">    </span><span class="n">threadList</span><span class="o">:</span><span class="w"> </span><span class="k">array</span><span class="p">[</span><span class="mi">1</span><span class="o">..</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">TCustomThread</span><span class="o">;</span>
</span><span id="__span-3-97"><a id="__codelineno-3-97" name="__codelineno-3-97" href="#__codelineno-3-97"></a><span class="w">    </span><span class="n">isAllThreadsFinished</span><span class="o">:</span><span class="kt">boolean</span><span class="o">;</span>
</span><span id="__span-3-98"><a id="__codelineno-3-98" name="__codelineno-3-98" href="#__codelineno-3-98"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-3-99"><a id="__codelineno-3-99" name="__codelineno-3-99" href="#__codelineno-3-99"></a><span class="w">    </span><span class="n">mainCounter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
</span><span id="__span-3-100"><a id="__codelineno-3-100" name="__codelineno-3-100" href="#__codelineno-3-100"></a>
</span><span id="__span-3-101"><a id="__codelineno-3-101" name="__codelineno-3-101" href="#__codelineno-3-101"></a><span class="w">    </span><span class="c1">// 1. Initialises a critical section.</span>
</span><span id="__span-3-102"><a id="__codelineno-3-102" name="__codelineno-3-102" href="#__codelineno-3-102"></a><span class="w">    </span><span class="c1">//    This call must be made before either EnterCrititicalSection or</span>
</span><span id="__span-3-103"><a id="__codelineno-3-103" name="__codelineno-3-103" href="#__codelineno-3-103"></a><span class="w">    </span><span class="c1">//    LeaveCriticalSection is used.</span>
</span><span id="__span-3-104"><a id="__codelineno-3-104" name="__codelineno-3-104" href="#__codelineno-3-104"></a><span class="w">    </span><span class="n">InitCriticalSection</span><span class="p">(</span><span class="n">criticalSection</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-3-105"><a id="__codelineno-3-105" name="__codelineno-3-105" href="#__codelineno-3-105"></a>
</span><span id="__span-3-106"><a id="__codelineno-3-106" name="__codelineno-3-106" href="#__codelineno-3-106"></a><span class="w">    </span><span class="c1">// Start the threadList</span>
</span><span id="__span-3-107"><a id="__codelineno-3-107" name="__codelineno-3-107" href="#__codelineno-3-107"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Low</span><span class="p">(</span><span class="n">threadList</span><span class="p">)</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nb">High</span><span class="p">(</span><span class="n">threadList</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-3-108"><a id="__codelineno-3-108" name="__codelineno-3-108" href="#__codelineno-3-108"></a><span class="w">      </span><span class="n">threadList</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TCustomThread</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="k">False</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-3-109"><a id="__codelineno-3-109" name="__codelineno-3-109" href="#__codelineno-3-109"></a>
</span><span id="__span-3-110"><a id="__codelineno-3-110" name="__codelineno-3-110" href="#__codelineno-3-110"></a><span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'All threads created ...'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-3-111"><a id="__codelineno-3-111" name="__codelineno-3-111" href="#__codelineno-3-111"></a>
</span><span id="__span-3-112"><a id="__codelineno-3-112" name="__codelineno-3-112" href="#__codelineno-3-112"></a><span class="w">    </span><span class="c1">// Wait till all threadList finished</span>
</span><span id="__span-3-113"><a id="__codelineno-3-113" name="__codelineno-3-113" href="#__codelineno-3-113"></a><span class="w">    </span><span class="k">repeat</span>
</span><span id="__span-3-114"><a id="__codelineno-3-114" name="__codelineno-3-114" href="#__codelineno-3-114"></a><span class="w">      </span><span class="n">isAllThreadsFinished</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">True</span><span class="o">;</span>
</span><span id="__span-3-115"><a id="__codelineno-3-115" name="__codelineno-3-115" href="#__codelineno-3-115"></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Low</span><span class="p">(</span><span class="n">threadList</span><span class="p">)</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nb">High</span><span class="p">(</span><span class="n">threadList</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-3-116"><a id="__codelineno-3-116" name="__codelineno-3-116" href="#__codelineno-3-116"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">threadList</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">.</span><span class="n">isFinished</span><span class="w"> </span><span class="k">then</span><span class="w"> </span><span class="n">isAllThreadsFinished</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">False</span><span class="o">;</span>
</span><span id="__span-3-117"><a id="__codelineno-3-117" name="__codelineno-3-117" href="#__codelineno-3-117"></a><span class="w">    </span><span class="k">until</span><span class="w"> </span><span class="n">isAllThreadsFinished</span><span class="o">;</span>
</span><span id="__span-3-118"><a id="__codelineno-3-118" name="__codelineno-3-118" href="#__codelineno-3-118"></a>
</span><span id="__span-3-119"><a id="__codelineno-3-119" name="__codelineno-3-119" href="#__codelineno-3-119"></a><span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'All threads completed ...'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-3-120"><a id="__codelineno-3-120" name="__codelineno-3-120" href="#__codelineno-3-120"></a>
</span><span id="__span-3-121"><a id="__codelineno-3-121" name="__codelineno-3-121" href="#__codelineno-3-121"></a><span class="w">    </span><span class="c1">// Free the threadList</span>
</span><span id="__span-3-122"><a id="__codelineno-3-122" name="__codelineno-3-122" href="#__codelineno-3-122"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Low</span><span class="p">(</span><span class="n">threadList</span><span class="p">)</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nb">High</span><span class="p">(</span><span class="n">threadList</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-3-123"><a id="__codelineno-3-123" name="__codelineno-3-123" href="#__codelineno-3-123"></a><span class="w">      </span><span class="n">threadList</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">.</span><span class="n">Free</span><span class="o">;</span>
</span><span id="__span-3-124"><a id="__codelineno-3-124" name="__codelineno-3-124" href="#__codelineno-3-124"></a>
</span><span id="__span-3-125"><a id="__codelineno-3-125" name="__codelineno-3-125" href="#__codelineno-3-125"></a><span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'All threads are freed ...'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-3-126"><a id="__codelineno-3-126" name="__codelineno-3-126" href="#__codelineno-3-126"></a>
</span><span id="__span-3-127"><a id="__codelineno-3-127" name="__codelineno-3-127" href="#__codelineno-3-127"></a><span class="w">    </span><span class="c1">// 4. Frees the resources associated with a critical section.</span>
</span><span id="__span-3-128"><a id="__codelineno-3-128" name="__codelineno-3-128" href="#__codelineno-3-128"></a><span class="w">    </span><span class="c1">//    After this call neither EnterCrititicalSection nor LeaveCriticalSection</span>
</span><span id="__span-3-129"><a id="__codelineno-3-129" name="__codelineno-3-129" href="#__codelineno-3-129"></a><span class="w">    </span><span class="c1">//    may be used.</span>
</span><span id="__span-3-130"><a id="__codelineno-3-130" name="__codelineno-3-130" href="#__codelineno-3-130"></a><span class="w">    </span><span class="n">DoneCriticalSection</span><span class="p">(</span><span class="n">criticalSection</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-3-131"><a id="__codelineno-3-131" name="__codelineno-3-131" href="#__codelineno-3-131"></a>
</span><span id="__span-3-132"><a id="__codelineno-3-132" name="__codelineno-3-132" href="#__codelineno-3-132"></a><span class="w">    </span><span class="c1">// Show the mainCounter</span>
</span><span id="__span-3-133"><a id="__codelineno-3-133" name="__codelineno-3-133" href="#__codelineno-3-133"></a><span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Printing the value of shared variable ...'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-3-134"><a id="__codelineno-3-134" name="__codelineno-3-134" href="#__codelineno-3-134"></a><span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Counter = '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">mainCounter</span><span class="p">))</span><span class="o">;</span>
</span><span id="__span-3-135"><a id="__codelineno-3-135" name="__codelineno-3-135" href="#__codelineno-3-135"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-3-136"><a id="__codelineno-3-136" name="__codelineno-3-136" href="#__codelineno-3-136"></a>
</span><span id="__span-3-137"><a id="__codelineno-3-137" name="__codelineno-3-137" href="#__codelineno-3-137"></a><span class="c1">// Main block ------------------------------------------------------------------</span>
</span><span id="__span-3-138"><a id="__codelineno-3-138" name="__codelineno-3-138" href="#__codelineno-3-138"></a><span class="k">begin</span>
</span><span id="__span-3-139"><a id="__codelineno-3-139" name="__codelineno-3-139" href="#__codelineno-3-139"></a><span class="w">  </span><span class="c1">// Print status of Critical Section</span>
</span><span id="__span-3-140"><a id="__codelineno-3-140" name="__codelineno-3-140" href="#__codelineno-3-140"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="n">isCriticalSectionEnabled</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-3-141"><a id="__codelineno-3-141" name="__codelineno-3-141" href="#__codelineno-3-141"></a><span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Critical Section: Enabled'</span><span class="p">)</span>
</span><span id="__span-3-142"><a id="__codelineno-3-142" name="__codelineno-3-142" href="#__codelineno-3-142"></a><span class="w">  </span><span class="k">else</span>
</span><span id="__span-3-143"><a id="__codelineno-3-143" name="__codelineno-3-143" href="#__codelineno-3-143"></a><span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Critical Section: Disabled'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-3-144"><a id="__codelineno-3-144" name="__codelineno-3-144" href="#__codelineno-3-144"></a>
</span><span id="__span-3-145"><a id="__codelineno-3-145" name="__codelineno-3-145" href="#__codelineno-3-145"></a><span class="w">  </span><span class="c1">// Callt he routine to increment a counter using multi-threading</span>
</span><span id="__span-3-146"><a id="__codelineno-3-146" name="__codelineno-3-146" href="#__codelineno-3-146"></a><span class="w">  </span><span class="n">IncrementCounter</span><span class="o">;</span>
</span><span id="__span-3-147"><a id="__codelineno-3-147" name="__codelineno-3-147" href="#__codelineno-3-147"></a>
</span><span id="__span-3-148"><a id="__codelineno-3-148" name="__codelineno-3-148" href="#__codelineno-3-148"></a><span class="w">  </span><span class="c1">// Pause console</span>
</span><span id="__span-3-149"><a id="__codelineno-3-149" name="__codelineno-3-149" href="#__codelineno-3-149"></a><span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Press Enter key to exit.'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-3-150"><a id="__codelineno-3-150" name="__codelineno-3-150" href="#__codelineno-3-150"></a><span class="w">  </span><span class="nb">ReadLn</span><span class="o">;</span>
</span><span id="__span-3-151"><a id="__codelineno-3-151" name="__codelineno-3-151" href="#__codelineno-3-151"></a><span class="k">end</span><span class="o">.</span>
</span></code></pre></div>
<h2 id="assigns-student-ids-to-student-names">Assigns student IDs to student names<a class="headerlink" href="#assigns-student-ids-to-student-names" title="Permanent link">¶</a></h2>
<p>This program assigns an ID to each student name from a text file and sorts them by student ID.</p>
<p>This snippet features:</p>
<ul>
<li><code>TFileStream</code> and <code>TStreamReader</code> for reading lines from a text file</li>
<li>Use of four threads to complete the task</li>
<li>Use of rounding-up division to split the workload between threads</li>
<li>Use of <code>TRTLCriticalSection</code> to ensure only one thread can write to the output list</li>
</ul>
<h3 id="the-commonpas-of-assigning-ids-to-names">The <code>common.pas</code> of assigning IDs to names<a class="headerlink" href="#the-commonpas-of-assigning-ids-to-names" title="Permanent link">¶</a></h3>
<p>This file holds the common type and variable declarations.</p>
<p>There are two important common variables here:</p>
<ol>
<li><code>startStudentID: int64 = 200000;</code> - This variable specifies the starting index for student IDs. All threads will read from this variable and increment it by one for other threads to read from. Therefore, reading and incrementing this variable MUST be done within a critical section to avoid race conditions.</li>
<li><code>finalStudentList: TStudentList;</code> - A list of TStudent records containing names and student IDs. All threads will write their output here, so writing to this variable MUST also be done within a critical section.</li>
</ol>
<div class="language-pascal highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span>
<span class="normal"><a href="#__codelineno-4-26">26</a></span>
<span class="normal"><a href="#__codelineno-4-27">27</a></span>
<span class="normal"><a href="#__codelineno-4-28">28</a></span>
<span class="normal"><a href="#__codelineno-4-29">29</a></span>
<span class="normal"><a href="#__codelineno-4-30">30</a></span>
<span class="normal"><a href="#__codelineno-4-31">31</a></span>
<span class="normal"><a href="#__codelineno-4-32">32</a></span>
<span class="normal"><a href="#__codelineno-4-33">33</a></span>
<span class="normal"><a href="#__codelineno-4-34">34</a></span>
<span class="normal"><a href="#__codelineno-4-35">35</a></span>
<span class="normal"><a href="#__codelineno-4-36">36</a></span>
<span class="normal"><a href="#__codelineno-4-37">37</a></span>
<span class="normal"><a href="#__codelineno-4-38">38</a></span>
<span class="normal"><a href="#__codelineno-4-39">39</a></span>
<span class="normal"><a href="#__codelineno-4-40">40</a></span>
<span class="normal"><a href="#__codelineno-4-41">41</a></span>
<span class="normal"><a href="#__codelineno-4-42">42</a></span>
<span class="normal"><a href="#__codelineno-4-43">43</a></span>
<span class="normal"><a href="#__codelineno-4-44">44</a></span>
<span class="normal"><a href="#__codelineno-4-45">45</a></span>
<span class="normal"><a href="#__codelineno-4-46">46</a></span>
<span class="normal"><a href="#__codelineno-4-47">47</a></span>
<span class="normal"><a href="#__codelineno-4-48">48</a></span>
<span class="normal"><a href="#__codelineno-4-49">49</a></span>
<span class="normal"><a href="#__codelineno-4-50">50</a></span>
<span class="normal"><a href="#__codelineno-4-51">51</a></span>
<span class="normal"><a href="#__codelineno-4-52">52</a></span>
<span class="normal"><a href="#__codelineno-4-53">53</a></span>
<span class="normal"><a href="#__codelineno-4-54">54</a></span>
<span class="normal"><a href="#__codelineno-4-55">55</a></span>
<span class="normal"><a href="#__codelineno-4-56">56</a></span>
<span class="normal"><a href="#__codelineno-4-57">57</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="k">unit</span><span class="w"> </span><span class="n">Common</span><span class="o">;</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="cm">{$mode ObjFPC}{$H+}</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="k">interface</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="k">uses</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">  </span><span class="n">Classes</span><span class="o">,</span><span class="w"> </span><span class="n">SysUtils</span><span class="o">,</span><span class="w"> </span><span class="n">Generics</span><span class="o">.</span><span class="n">Defaults</span><span class="o">,</span><span class="w"> </span><span class="n">Generics</span><span class="o">.</span><span class="n">Collections</span><span class="o">,</span><span class="w"> </span><span class="n">Math</span><span class="o">;</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="k">type</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a><span class="w">  </span><span class="c1">// A record to hold student information.</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">  </span><span class="n">TStudent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">record</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="n">Name</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="n">id</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="k">type</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a><span class="w">  </span><span class="c1">// A list to hold student records, along with a comparer for</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="w">  </span><span class="c1">// sorting the list afterwards.</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">  </span><span class="n">TStudentList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">specialize</span><span class="w"> </span><span class="n">TList</span><span class="o">&lt;</span><span class="n">TStudent</span><span class="o">&gt;;</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">  </span><span class="n">TStudentListComparer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">specialize</span><span class="w"> </span><span class="n">TComparer</span><span class="o">&lt;</span><span class="n">TStudent</span><span class="o">&gt;;</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="k">type</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="w">  </span><span class="c1">// A type of string list.</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26"></a><span class="w">  </span><span class="n">TStrList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">specialize</span><span class="w"> </span><span class="n">TList</span><span class="o">&lt;</span><span class="k">string</span><span class="o">&gt;;</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27"></a>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28"></a><span class="k">const</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29"></a><span class="w">  </span><span class="c1">// Number of maximum threads to use.</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30"></a><span class="w">  </span><span class="n">maxThreads</span><span class="o">:</span><span class="w"> </span><span class="kt">int64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="o">;</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31"></a>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32"></a><span class="k">var</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33"></a><span class="w">  </span><span class="c1">// This variable specifies the lowest index for student ID.</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34"></a><span class="w">  </span><span class="c1">// All threads will be reading from this variable and increase by one</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35"></a><span class="w">  </span><span class="c1">// for other threads to read from.</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36"></a><span class="w">  </span><span class="c1">// Hence, reading and increment of this variable MUST be done</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37"></a><span class="w">  </span><span class="c1">// from within a critical section to avoid race.</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38"></a><span class="w">  </span><span class="n">startStudentID</span><span class="o">:</span><span class="w"> </span><span class="kt">int64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200000</span><span class="o">;</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39"></a>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40"></a><span class="w">  </span><span class="c1">// A list of TStudent records. All threads will write student names and</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41"></a><span class="w">  </span><span class="c1">// student IDs into this variable.</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42"></a><span class="w">  </span><span class="c1">// Hence, writing to this variable MUST be done from within</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43"></a><span class="w">  </span><span class="c1">// a critical section too.</span>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44"></a><span class="w">  </span><span class="n">finalStudentList</span><span class="o">:</span><span class="w"> </span><span class="n">TStudentList</span><span class="o">;</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45"></a>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46"></a><span class="c1">// Custom comparison function for sorting by name - ascending</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47"></a><span class="k">function</span><span class="w"> </span><span class="nf">CompareID</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">LeftItem</span><span class="o">,</span><span class="w"> </span><span class="n">RightItem</span><span class="o">:</span><span class="w"> </span><span class="n">TStudent</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48"></a>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49"></a><span class="k">implementation</span>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50"></a>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51"></a><span class="c1">// Custom comparison function for sorting by student id - ascending</span>
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52"></a><span class="k">function</span><span class="w"> </span><span class="nf">CompareID</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">LeftItem</span><span class="o">,</span><span class="w"> </span><span class="n">RightItem</span><span class="o">:</span><span class="w"> </span><span class="n">TStudent</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53"></a><span class="k">begin</span>
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54"></a><span class="w">  </span><span class="bp">Result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">CompareValue</span><span class="p">(</span><span class="n">LeftItem</span><span class="o">.</span><span class="n">id</span><span class="o">,</span><span class="w"> </span><span class="n">RightItem</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55"></a><span class="k">end</span><span class="o">;</span>
</span><span id="__span-4-56"><a id="__codelineno-4-56" name="__codelineno-4-56"></a>
</span><span id="__span-4-57"><a id="__codelineno-4-57" name="__codelineno-4-57"></a><span class="k">end</span><span class="o">.</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="the-customthreadpas-of-assigning-ids-to-names">The <code>customthread.pas</code> of assigning IDs to names<a class="headerlink" href="#the-customthreadpas-of-assigning-ids-to-names" title="Permanent link">¶</a></h3>
<p>This file defines the implementation of a custom thread based on <code>TThread</code>.</p>
<p>There are important things to note here:</p>
<ol>
<li>The implementation includes a <code>destructor</code> to clean up the list used by the threads for the task (lines 30, 63-69).</li>
<li>The thread receives an array but only processes a portion of it based on the rounding-up division algorithm defined in the main block.</li>
<li><code>FreeOnTerminate := False</code> as the main thread is responsible for managing the freeing of all threads (line 47).</li>
<li>The <code>Execute</code> method updates shared variables within a critical section (lines 79-91).</li>
</ol>
<div class="language-pascal highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span>
<span class="normal"><a href="#__codelineno-5-19">19</a></span>
<span class="normal"><a href="#__codelineno-5-20">20</a></span>
<span class="normal"><a href="#__codelineno-5-21">21</a></span>
<span class="normal"><a href="#__codelineno-5-22">22</a></span>
<span class="normal"><a href="#__codelineno-5-23">23</a></span>
<span class="normal"><a href="#__codelineno-5-24">24</a></span>
<span class="normal"><a href="#__codelineno-5-25">25</a></span>
<span class="normal"><a href="#__codelineno-5-26">26</a></span>
<span class="normal"><a href="#__codelineno-5-27">27</a></span>
<span class="normal"><a href="#__codelineno-5-28">28</a></span>
<span class="normal"><a href="#__codelineno-5-29">29</a></span>
<span class="normal"><a href="#__codelineno-5-30">30</a></span>
<span class="normal"><a href="#__codelineno-5-31">31</a></span>
<span class="normal"><a href="#__codelineno-5-32">32</a></span>
<span class="normal"><a href="#__codelineno-5-33">33</a></span>
<span class="normal"><a href="#__codelineno-5-34">34</a></span>
<span class="normal"><a href="#__codelineno-5-35">35</a></span>
<span class="normal"><a href="#__codelineno-5-36">36</a></span>
<span class="normal"><a href="#__codelineno-5-37">37</a></span>
<span class="normal"><a href="#__codelineno-5-38">38</a></span>
<span class="normal"><a href="#__codelineno-5-39">39</a></span>
<span class="normal"><a href="#__codelineno-5-40">40</a></span>
<span class="normal"><a href="#__codelineno-5-41">41</a></span>
<span class="normal"><a href="#__codelineno-5-42">42</a></span>
<span class="normal"><a href="#__codelineno-5-43">43</a></span>
<span class="normal"><a href="#__codelineno-5-44">44</a></span>
<span class="normal"><a href="#__codelineno-5-45">45</a></span>
<span class="normal"><a href="#__codelineno-5-46">46</a></span>
<span class="normal"><a href="#__codelineno-5-47">47</a></span>
<span class="normal"><a href="#__codelineno-5-48">48</a></span>
<span class="normal"><a href="#__codelineno-5-49">49</a></span>
<span class="normal"><a href="#__codelineno-5-50">50</a></span>
<span class="normal"><a href="#__codelineno-5-51">51</a></span>
<span class="normal"><a href="#__codelineno-5-52">52</a></span>
<span class="normal"><a href="#__codelineno-5-53">53</a></span>
<span class="normal"><a href="#__codelineno-5-54">54</a></span>
<span class="normal"><a href="#__codelineno-5-55">55</a></span>
<span class="normal"><a href="#__codelineno-5-56">56</a></span>
<span class="normal"><a href="#__codelineno-5-57">57</a></span>
<span class="normal"><a href="#__codelineno-5-58">58</a></span>
<span class="normal"><a href="#__codelineno-5-59">59</a></span>
<span class="normal"><a href="#__codelineno-5-60">60</a></span>
<span class="normal"><a href="#__codelineno-5-61">61</a></span>
<span class="normal"><a href="#__codelineno-5-62">62</a></span>
<span class="normal"><a href="#__codelineno-5-63">63</a></span>
<span class="normal"><a href="#__codelineno-5-64">64</a></span>
<span class="normal"><a href="#__codelineno-5-65">65</a></span>
<span class="normal"><a href="#__codelineno-5-66">66</a></span>
<span class="normal"><a href="#__codelineno-5-67">67</a></span>
<span class="normal"><a href="#__codelineno-5-68">68</a></span>
<span class="normal"><a href="#__codelineno-5-69">69</a></span>
<span class="normal"><a href="#__codelineno-5-70">70</a></span>
<span class="normal"><a href="#__codelineno-5-71">71</a></span>
<span class="normal"><a href="#__codelineno-5-72">72</a></span>
<span class="normal"><a href="#__codelineno-5-73">73</a></span>
<span class="normal"><a href="#__codelineno-5-74">74</a></span>
<span class="normal"><a href="#__codelineno-5-75">75</a></span>
<span class="normal"><a href="#__codelineno-5-76">76</a></span>
<span class="normal"><a href="#__codelineno-5-77">77</a></span>
<span class="normal"><a href="#__codelineno-5-78">78</a></span>
<span class="normal"><a href="#__codelineno-5-79">79</a></span>
<span class="normal"><a href="#__codelineno-5-80">80</a></span>
<span class="normal"><a href="#__codelineno-5-81">81</a></span>
<span class="normal"><a href="#__codelineno-5-82">82</a></span>
<span class="normal"><a href="#__codelineno-5-83">83</a></span>
<span class="normal"><a href="#__codelineno-5-84">84</a></span>
<span class="normal"><a href="#__codelineno-5-85">85</a></span>
<span class="normal"><a href="#__codelineno-5-86">86</a></span>
<span class="normal"><a href="#__codelineno-5-87">87</a></span>
<span class="normal"><a href="#__codelineno-5-88">88</a></span>
<span class="normal"><a href="#__codelineno-5-89">89</a></span>
<span class="normal"><a href="#__codelineno-5-90">90</a></span>
<span class="normal"><a href="#__codelineno-5-91">91</a></span>
<span class="normal"><a href="#__codelineno-5-92">92</a></span>
<span class="normal"><a href="#__codelineno-5-93">93</a></span>
<span class="normal"><a href="#__codelineno-5-94">94</a></span>
<span class="normal"><a href="#__codelineno-5-95">95</a></span>
<span class="normal"><a href="#__codelineno-5-96">96</a></span>
<span class="normal"><a href="#__codelineno-5-97">97</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">unit</span><span class="w"> </span><span class="n">CustomThread</span><span class="o">;</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="cm">{$mode ObjFPC}{$H+}{$J-}</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="k">interface</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="k">uses</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">  </span><span class="n">Classes</span><span class="o">,</span><span class="w"> </span><span class="n">SysUtils</span><span class="o">,</span><span class="w"> </span><span class="n">Common</span><span class="o">;</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">  </span><span class="c1">// Create a thread class deriving from TThread.</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="k">type</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">  </span><span class="c1">// The TThread class encapsulates the native thread support of the OS.</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">  </span><span class="c1">// To create a thread, (1) declare a child of the TThread object, ...</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14"></a><span class="w">  </span><span class="n">TCustomThread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">class</span><span class="p">(</span><span class="n">TThread</span><span class="p">)</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="c1">// (with a data to work with)</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16"></a><span class="w">  </span><span class="kp">private</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">    </span><span class="c1">// A TStrList to store the input array for this thread, along with</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="w">    </span><span class="c1">// a variable to store an instance of critical section.</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19"></a><span class="w">    </span><span class="n">list</span><span class="o">:</span><span class="w"> </span><span class="n">TStrList</span><span class="o">;</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20"></a><span class="w">    </span><span class="n">cs</span><span class="o">:</span><span class="n">TRTLCriticalSection</span><span class="o">;</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21"></a><span class="w">  </span><span class="kp">protected</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22"></a><span class="w">    </span><span class="c1">// (2) override the Execute method, and ...</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23"></a><span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">Execute</span><span class="o">;</span><span class="w"> </span><span class="kp">override</span><span class="o">;</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24"></a><span class="w">  </span><span class="kp">public</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25"></a><span class="w">    </span><span class="c1">// (3) include a constructor to setup variables for executing this thread.</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26"></a><span class="w">    </span><span class="k">constructor</span><span class="w"> </span><span class="nf">Create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">criticalSection</span><span class="o">:</span><span class="w"> </span><span class="n">TRTLCriticalSection</span><span class="o">;</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27"></a><span class="w">                       </span><span class="k">const</span><span class="w"> </span><span class="n">listToProcess</span><span class="o">:</span><span class="w"> </span><span class="n">TStrList</span><span class="o">;</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28"></a><span class="w">                       </span><span class="k">const</span><span class="w"> </span><span class="n">startIndex</span><span class="o">,</span><span class="w"> </span><span class="n">finishIndex</span><span class="o">:</span><span class="w"> </span><span class="kt">int64</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29"></a><span class="w">    </span><span class="c1">// (4) lastly, include  destructor to free the TStrList of this thread.</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30"></a><span class="hll"><span class="w">    </span><span class="k">destructor</span><span class="w"> </span><span class="nf">Destroy</span><span class="o">;</span><span class="w"> </span><span class="kp">override</span><span class="o">;</span>
</span></span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32"></a>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33"></a><span class="k">implementation</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34"></a>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35"></a><span class="c1">// Create the Custom Thread with an input list to process.</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36"></a><span class="k">constructor</span><span class="w"> </span><span class="nc">TCustomThread</span><span class="o">.</span><span class="nf">Create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">criticalSection</span><span class="o">:</span><span class="w"> </span><span class="n">TRTLCriticalSection</span><span class="o">;</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37"></a><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="n">listToProcess</span><span class="o">:</span><span class="w"> </span><span class="n">TStrList</span><span class="o">;</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38"></a><span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="n">startIndex</span><span class="o">,</span><span class="w"> </span><span class="n">finishIndex</span><span class="o">:</span><span class="w"> </span><span class="kt">int64</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39"></a><span class="k">var</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40"></a><span class="w">  </span><span class="kp">index</span><span class="o">:</span><span class="w"> </span><span class="kt">int64</span><span class="o">;</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41"></a><span class="k">begin</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42"></a><span class="w">  </span><span class="c1">// Call parent's constructor</span>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43"></a><span class="w">  </span><span class="c1">// If user pass True, thread won't start automatically</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44"></a><span class="w">  </span><span class="k">inherited</span><span class="w"> </span><span class="n">Create</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-5-45"><a id="__codelineno-5-45" name="__codelineno-5-45"></a>
</span><span id="__span-5-46"><a id="__codelineno-5-46" name="__codelineno-5-46"></a><span class="w">  </span><span class="c1">// Not free threads on terminate.</span>
</span><span id="__span-5-47"><a id="__codelineno-5-47" name="__codelineno-5-47"></a><span class="w">  </span><span class="c1">// Threads will be freed from the main thread.</span>
</span><span id="__span-5-48"><a id="__codelineno-5-48" name="__codelineno-5-48"></a><span class="hll"><span class="w">  </span><span class="n">FreeOnTerminate</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">False</span><span class="o">;</span>
</span></span><span id="__span-5-49"><a id="__codelineno-5-49" name="__codelineno-5-49"></a>
</span><span id="__span-5-50"><a id="__codelineno-5-50" name="__codelineno-5-50"></a><span class="w">  </span><span class="c1">// Assign critical section</span>
</span><span id="__span-5-51"><a id="__codelineno-5-51" name="__codelineno-5-51"></a><span class="w">  </span><span class="k">self</span><span class="o">.</span><span class="n">cs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">criticalSection</span><span class="o">;</span>
</span><span id="__span-5-52"><a id="__codelineno-5-52" name="__codelineno-5-52"></a>
</span><span id="__span-5-53"><a id="__codelineno-5-53" name="__codelineno-5-53"></a><span class="w">  </span><span class="c1">// Populate the internal list for the Execute procedure</span>
</span><span id="__span-5-54"><a id="__codelineno-5-54" name="__codelineno-5-54"></a><span class="w">  </span><span class="k">self</span><span class="o">.</span><span class="n">list</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TStrList</span><span class="o">.</span><span class="n">Create</span><span class="o">;</span>
</span><span id="__span-5-55"><a id="__codelineno-5-55" name="__codelineno-5-55"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">startIndex</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">finishIndex</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-5-56"><a id="__codelineno-5-56" name="__codelineno-5-56"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-5-57"><a id="__codelineno-5-57" name="__codelineno-5-57"></a><span class="w">    </span><span class="k">self</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">listToProcess</span><span class="p">[</span><span class="kp">index</span><span class="p">])</span><span class="o">;</span>
</span><span id="__span-5-58"><a id="__codelineno-5-58" name="__codelineno-5-58"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-5-59"><a id="__codelineno-5-59" name="__codelineno-5-59"></a>
</span><span id="__span-5-60"><a id="__codelineno-5-60" name="__codelineno-5-60"></a><span class="w">  </span><span class="c1">// User feedback</span>
</span><span id="__span-5-61"><a id="__codelineno-5-61" name="__codelineno-5-61"></a><span class="w">  </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Thread created with id: '</span><span class="o">,</span><span class="w"> </span><span class="n">ThreadID</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-5-62"><a id="__codelineno-5-62" name="__codelineno-5-62"></a><span class="k">end</span><span class="o">;</span>
</span><span id="__span-5-63"><a id="__codelineno-5-63" name="__codelineno-5-63"></a>
</span><span id="__span-5-64"><a id="__codelineno-5-64" name="__codelineno-5-64"></a><span class="hll"><span class="k">destructor</span><span class="w"> </span><span class="nc">TCustomThread</span><span class="o">.</span><span class="nf">Destroy</span><span class="o">;</span>
</span></span><span id="__span-5-65"><a id="__codelineno-5-65" name="__codelineno-5-65"></a><span class="hll"><span class="k">begin</span>
</span></span><span id="__span-5-66"><a id="__codelineno-5-66" name="__codelineno-5-66"></a><span class="hll"><span class="w">  </span><span class="c1">// Free the TStrList.</span>
</span></span><span id="__span-5-67"><a id="__codelineno-5-67" name="__codelineno-5-67"></a><span class="hll"><span class="w">  </span><span class="k">self</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">Free</span><span class="o">;</span>
</span></span><span id="__span-5-68"><a id="__codelineno-5-68" name="__codelineno-5-68"></a><span class="hll"><span class="w">  </span><span class="c1">// Call parents' Destroy.</span>
</span></span><span id="__span-5-69"><a id="__codelineno-5-69" name="__codelineno-5-69"></a><span class="hll"><span class="w">  </span><span class="k">inherited</span><span class="w"> </span><span class="n">Destroy</span><span class="o">;</span>
</span></span><span id="__span-5-70"><a id="__codelineno-5-70" name="__codelineno-5-70"></a><span class="hll"><span class="k">end</span><span class="o">;</span>
</span></span><span id="__span-5-71"><a id="__codelineno-5-71" name="__codelineno-5-71"></a>
</span><span id="__span-5-72"><a id="__codelineno-5-72" name="__codelineno-5-72"></a><span class="c1">// Enter and leave Critical Section here.</span>
</span><span id="__span-5-73"><a id="__codelineno-5-73" name="__codelineno-5-73"></a><span class="k">procedure</span><span class="w"> </span><span class="nc">TCustomThread</span><span class="o">.</span><span class="nf">Execute</span><span class="o">;</span>
</span><span id="__span-5-74"><a id="__codelineno-5-74" name="__codelineno-5-74"></a><span class="k">var</span>
</span><span id="__span-5-75"><a id="__codelineno-5-75" name="__codelineno-5-75"></a><span class="w">  </span><span class="kp">index</span><span class="o">:</span><span class="w"> </span><span class="kt">int64</span><span class="o">;</span>
</span><span id="__span-5-76"><a id="__codelineno-5-76" name="__codelineno-5-76"></a><span class="w">  </span><span class="n">student</span><span class="o">:</span><span class="w"> </span><span class="n">TStudent</span><span class="o">;</span>
</span><span id="__span-5-77"><a id="__codelineno-5-77" name="__codelineno-5-77"></a><span class="k">begin</span>
</span><span id="__span-5-78"><a id="__codelineno-5-78" name="__codelineno-5-78"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">self</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">Count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-5-79"><a id="__codelineno-5-79" name="__codelineno-5-79"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-5-80"><a id="__codelineno-5-80" name="__codelineno-5-80"></a><span class="hll"><span class="w">    </span><span class="n">EnterCriticalSection</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span><span class="o">;</span><span class="w"> </span><span class="c1">// --------------------------------- enter cs</span>
</span></span><span id="__span-5-81"><a id="__codelineno-5-81" name="__codelineno-5-81"></a><span class="hll"><span class="w">    </span><span class="k">try</span>
</span></span><span id="__span-5-82"><a id="__codelineno-5-82" name="__codelineno-5-82"></a><span class="hll"><span class="w">      </span><span class="c1">// Add student - ID pair as TStudent, then add into TStudentList</span>
</span></span><span id="__span-5-83"><a id="__codelineno-5-83" name="__codelineno-5-83"></a><span class="hll"><span class="w">      </span><span class="c1">//   1. Get the name from the list with allocated index</span>
</span></span><span id="__span-5-84"><a id="__codelineno-5-84" name="__codelineno-5-84"></a><span class="hll"><span class="w">      </span><span class="n">student</span><span class="o">.</span><span class="n">Name</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">list</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">;</span>
</span></span><span id="__span-5-85"><a id="__codelineno-5-85" name="__codelineno-5-85"></a><span class="hll"><span class="w">      </span><span class="c1">//   2. Get the starting student ID from</span>
</span></span><span id="__span-5-86"><a id="__codelineno-5-86" name="__codelineno-5-86"></a><span class="hll"><span class="w">      </span><span class="n">student</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">startStudentID</span><span class="o">;</span>
</span></span><span id="__span-5-87"><a id="__codelineno-5-87" name="__codelineno-5-87"></a><span class="hll"><span class="w">      </span><span class="c1">//   3. Add TStudent into TStudentList (the main block does the init)</span>
</span></span><span id="__span-5-88"><a id="__codelineno-5-88" name="__codelineno-5-88"></a><span class="hll"><span class="w">      </span><span class="n">finalStudentList</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">student</span><span class="p">)</span><span class="o">;</span>
</span></span><span id="__span-5-89"><a id="__codelineno-5-89" name="__codelineno-5-89"></a><span class="hll"><span class="w">      </span><span class="c1">// After a student - ID pair is added, increment the current student ID by 1</span>
</span></span><span id="__span-5-90"><a id="__codelineno-5-90" name="__codelineno-5-90"></a><span class="hll"><span class="w">      </span><span class="n">startStudentID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">startStudentID</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
</span></span><span id="__span-5-91"><a id="__codelineno-5-91" name="__codelineno-5-91"></a><span class="hll"><span class="w">    </span><span class="k">finally</span>
</span></span><span id="__span-5-92"><a id="__codelineno-5-92" name="__codelineno-5-92"></a><span class="hll"><span class="w">      </span><span class="n">LeaveCriticalSection</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span><span class="o">;</span><span class="w"> </span><span class="c1">// ------------------------------- leave cs</span>
</span></span><span id="__span-5-93"><a id="__codelineno-5-93" name="__codelineno-5-93"></a><span class="w">    </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-5-94"><a id="__codelineno-5-94" name="__codelineno-5-94"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-5-95"><a id="__codelineno-5-95" name="__codelineno-5-95"></a><span class="k">end</span><span class="o">;</span>
</span><span id="__span-5-96"><a id="__codelineno-5-96" name="__codelineno-5-96"></a>
</span><span id="__span-5-97"><a id="__codelineno-5-97" name="__codelineno-5-97"></a><span class="k">end</span><span class="o">.</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h3 id="the-main-program-of-assigning-ids-to-names">The main program of assigning IDs to names<a class="headerlink" href="#the-main-program-of-assigning-ids-to-names" title="Permanent link">¶</a></h3>
<p>Key features of the main snippet:</p>
<ol>
<li>The text file is read into <code>strList</code>.</li>
<li>Threads are created and assigned specific subarrays to process.</li>
<li>Critical sections ensure safe access to shared variables.</li>
<li>After the threads finish, the results are sorted and printed.</li>
</ol>
<div class="language-pascal highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">  1</a></span>
<span class="normal"><a href="#__codelineno-6-2">  2</a></span>
<span class="normal"><a href="#__codelineno-6-3">  3</a></span>
<span class="normal"><a href="#__codelineno-6-4">  4</a></span>
<span class="normal"><a href="#__codelineno-6-5">  5</a></span>
<span class="normal"><a href="#__codelineno-6-6">  6</a></span>
<span class="normal"><a href="#__codelineno-6-7">  7</a></span>
<span class="normal"><a href="#__codelineno-6-8">  8</a></span>
<span class="normal"><a href="#__codelineno-6-9">  9</a></span>
<span class="normal"><a href="#__codelineno-6-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-6-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-6-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-6-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-6-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-6-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-6-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-6-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-6-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-6-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-6-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-6-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-6-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-6-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-6-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-6-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-6-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-6-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-6-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-6-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-6-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-6-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-6-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-6-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-6-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-6-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-6-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-6-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-6-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-6-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-6-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-6-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-6-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-6-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-6-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-6-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-6-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-6-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-6-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-6-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-6-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-6-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-6-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-6-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-6-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-6-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-6-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-6-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-6-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-6-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-6-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-6-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-6-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-6-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-6-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-6-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-6-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-6-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-6-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-6-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-6-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-6-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-6-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-6-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-6-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-6-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-6-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-6-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-6-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-6-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-6-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-6-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-6-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-6-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-6-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-6-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-6-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-6-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-6-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-6-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-6-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-6-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-6-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-6-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-6-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-6-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-6-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-6-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-6-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-6-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-6-100">100</a></span>
<span class="normal"><a href="#__codelineno-6-101">101</a></span>
<span class="normal"><a href="#__codelineno-6-102">102</a></span>
<span class="normal"><a href="#__codelineno-6-103">103</a></span>
<span class="normal"><a href="#__codelineno-6-104">104</a></span>
<span class="normal"><a href="#__codelineno-6-105">105</a></span>
<span class="normal"><a href="#__codelineno-6-106">106</a></span>
<span class="normal"><a href="#__codelineno-6-107">107</a></span>
<span class="normal"><a href="#__codelineno-6-108">108</a></span>
<span class="normal"><a href="#__codelineno-6-109">109</a></span>
<span class="normal"><a href="#__codelineno-6-110">110</a></span>
<span class="normal"><a href="#__codelineno-6-111">111</a></span>
<span class="normal"><a href="#__codelineno-6-112">112</a></span>
<span class="normal"><a href="#__codelineno-6-113">113</a></span>
<span class="normal"><a href="#__codelineno-6-114">114</a></span>
<span class="normal"><a href="#__codelineno-6-115">115</a></span>
<span class="normal"><a href="#__codelineno-6-116">116</a></span>
<span class="normal"><a href="#__codelineno-6-117">117</a></span>
<span class="normal"><a href="#__codelineno-6-118">118</a></span>
<span class="normal"><a href="#__codelineno-6-119">119</a></span>
<span class="normal"><a href="#__codelineno-6-120">120</a></span>
<span class="normal"><a href="#__codelineno-6-121">121</a></span>
<span class="normal"><a href="#__codelineno-6-122">122</a></span>
<span class="normal"><a href="#__codelineno-6-123">123</a></span>
<span class="normal"><a href="#__codelineno-6-124">124</a></span>
<span class="normal"><a href="#__codelineno-6-125">125</a></span>
<span class="normal"><a href="#__codelineno-6-126">126</a></span>
<span class="normal"><a href="#__codelineno-6-127">127</a></span>
<span class="normal"><a href="#__codelineno-6-128">128</a></span>
<span class="normal"><a href="#__codelineno-6-129">129</a></span>
<span class="normal"><a href="#__codelineno-6-130">130</a></span>
<span class="normal"><a href="#__codelineno-6-131">131</a></span>
<span class="normal"><a href="#__codelineno-6-132">132</a></span>
<span class="normal"><a href="#__codelineno-6-133">133</a></span>
<span class="normal"><a href="#__codelineno-6-134">134</a></span>
<span class="normal"><a href="#__codelineno-6-135">135</a></span>
<span class="normal"><a href="#__codelineno-6-136">136</a></span>
<span class="normal"><a href="#__codelineno-6-137">137</a></span>
<span class="normal"><a href="#__codelineno-6-138">138</a></span>
<span class="normal"><a href="#__codelineno-6-139">139</a></span>
<span class="normal"><a href="#__codelineno-6-140">140</a></span>
<span class="normal"><a href="#__codelineno-6-141">141</a></span>
<span class="normal"><a href="#__codelineno-6-142">142</a></span>
<span class="normal"><a href="#__codelineno-6-143">143</a></span>
<span class="normal"><a href="#__codelineno-6-144">144</a></span>
<span class="normal"><a href="#__codelineno-6-145">145</a></span>
<span class="normal"><a href="#__codelineno-6-146">146</a></span>
<span class="normal"><a href="#__codelineno-6-147">147</a></span>
<span class="normal"><a href="#__codelineno-6-148">148</a></span>
<span class="normal"><a href="#__codelineno-6-149">149</a></span>
<span class="normal"><a href="#__codelineno-6-150">150</a></span>
<span class="normal"><a href="#__codelineno-6-151">151</a></span>
<span class="normal"><a href="#__codelineno-6-152">152</a></span>
<span class="normal"><a href="#__codelineno-6-153">153</a></span>
<span class="normal"><a href="#__codelineno-6-154">154</a></span>
<span class="normal"><a href="#__codelineno-6-155">155</a></span>
<span class="normal"><a href="#__codelineno-6-156">156</a></span>
<span class="normal"><a href="#__codelineno-6-157">157</a></span>
<span class="normal"><a href="#__codelineno-6-158">158</a></span>
<span class="normal"><a href="#__codelineno-6-159">159</a></span>
<span class="normal"><a href="#__codelineno-6-160">160</a></span>
<span class="normal"><a href="#__codelineno-6-161">161</a></span>
<span class="normal"><a href="#__codelineno-6-162">162</a></span>
<span class="normal"><a href="#__codelineno-6-163">163</a></span>
<span class="normal"><a href="#__codelineno-6-164">164</a></span>
<span class="normal"><a href="#__codelineno-6-165">165</a></span>
<span class="normal"><a href="#__codelineno-6-166">166</a></span>
<span class="normal"><a href="#__codelineno-6-167">167</a></span>
<span class="normal"><a href="#__codelineno-6-168">168</a></span>
<span class="normal"><a href="#__codelineno-6-169">169</a></span>
<span class="normal"><a href="#__codelineno-6-170">170</a></span>
<span class="normal"><a href="#__codelineno-6-171">171</a></span>
<span class="normal"><a href="#__codelineno-6-172">172</a></span>
<span class="normal"><a href="#__codelineno-6-173">173</a></span>
<span class="normal"><a href="#__codelineno-6-174">174</a></span>
<span class="normal"><a href="#__codelineno-6-175">175</a></span>
<span class="normal"><a href="#__codelineno-6-176">176</a></span>
<span class="normal"><a href="#__codelineno-6-177">177</a></span>
<span class="normal"><a href="#__codelineno-6-178">178</a></span>
<span class="normal"><a href="#__codelineno-6-179">179</a></span>
<span class="normal"><a href="#__codelineno-6-180">180</a></span>
<span class="normal"><a href="#__codelineno-6-181">181</a></span>
<span class="normal"><a href="#__codelineno-6-182">182</a></span>
<span class="normal"><a href="#__codelineno-6-183">183</a></span>
<span class="normal"><a href="#__codelineno-6-184">184</a></span>
<span class="normal"><a href="#__codelineno-6-185">185</a></span>
<span class="normal"><a href="#__codelineno-6-186">186</a></span>
<span class="normal"><a href="#__codelineno-6-187">187</a></span>
<span class="normal"><a href="#__codelineno-6-188">188</a></span>
<span class="normal"><a href="#__codelineno-6-189">189</a></span>
<span class="normal"><a href="#__codelineno-6-190">190</a></span>
<span class="normal"><a href="#__codelineno-6-191">191</a></span>
<span class="normal"><a href="#__codelineno-6-192">192</a></span>
<span class="normal"><a href="#__codelineno-6-193">193</a></span>
<span class="normal"><a href="#__codelineno-6-194">194</a></span>
<span class="normal"><a href="#__codelineno-6-195">195</a></span>
<span class="normal"><a href="#__codelineno-6-196">196</a></span>
<span class="normal"><a href="#__codelineno-6-197">197</a></span>
<span class="normal"><a href="#__codelineno-6-198">198</a></span>
<span class="normal"><a href="#__codelineno-6-199">199</a></span>
<span class="normal"><a href="#__codelineno-6-200">200</a></span>
<span class="normal"><a href="#__codelineno-6-201">201</a></span>
<span class="normal"><a href="#__codelineno-6-202">202</a></span>
<span class="normal"><a href="#__codelineno-6-203">203</a></span>
<span class="normal"><a href="#__codelineno-6-204">204</a></span>
<span class="normal"><a href="#__codelineno-6-205">205</a></span>
<span class="normal"><a href="#__codelineno-6-206">206</a></span>
<span class="normal"><a href="#__codelineno-6-207">207</a></span>
<span class="normal"><a href="#__codelineno-6-208">208</a></span>
<span class="normal"><a href="#__codelineno-6-209">209</a></span>
<span class="normal"><a href="#__codelineno-6-210">210</a></span>
<span class="normal"><a href="#__codelineno-6-211">211</a></span>
<span class="normal"><a href="#__codelineno-6-212">212</a></span>
<span class="normal"><a href="#__codelineno-6-213">213</a></span>
<span class="normal"><a href="#__codelineno-6-214">214</a></span>
<span class="normal"><a href="#__codelineno-6-215">215</a></span>
<span class="normal"><a href="#__codelineno-6-216">216</a></span>
<span class="normal"><a href="#__codelineno-6-217">217</a></span>
<span class="normal"><a href="#__codelineno-6-218">218</a></span>
<span class="normal"><a href="#__codelineno-6-219">219</a></span>
<span class="normal"><a href="#__codelineno-6-220">220</a></span>
<span class="normal"><a href="#__codelineno-6-221">221</a></span>
<span class="normal"><a href="#__codelineno-6-222">222</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="k">program</span><span class="w"> </span><span class="n">AssignStudentIDs</span><span class="o">;</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="cm">{</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="cm"> This program assigns student ID to each name from a text file by</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="cm"> using N number of threads.</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="cm"> Pre-requisite</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="cm">    - TThread for managing the threads.</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="cm">    - TRTLCriticalSection for ensuring only one thread can modify a shared</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="cm">      variable at one time.</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="cm">    - Input text file containing a list of names. For example;</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="cm">    Alyssa Morgan</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="cm">    Declan Hayes</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="cm">    Nora Patel</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="cm">    Miles Thompson</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="cm">    Sienna Larson</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a><span class="cm">    Kellan Rivera</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="cm">    Camille Chang</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="cm">    Jensen Park</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a><span class="cm">    Amara Singh</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="cm">    Holden Myers</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="cm">    Elise Howard</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="cm">    Luca Griffin</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a><span class="cm">    Reagan Patel</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="cm">    Kian Gallagher</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="cm">    Mara Nguyen</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29"></a><span class="cm">    ...</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="cm">    ...</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31"></a>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="cm"> Algorithm</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33"></a>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="cm">    - Read the text file into an array.</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35"></a><span class="cm">      - All threads will read from the same array, but at differing start and</span>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36"></a><span class="cm">        finish indexes. This depends on the number of max threads.</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="cm">    - Assign workloads to each thread.</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38"></a><span class="cm">      - Specify the start and finish indexes to each thread.</span>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="cm">      - Will use the rounding up division method to ensure near-equal division</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40"></a><span class="cm">        of workload for each thread.</span>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41"></a><span class="cm">    - Wait for the threads to finish and then free them.</span>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42"></a><span class="cm">    - Sort the final student list</span>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="cm">    - Print results on screen.</span>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44"></a>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45"></a><span class="cm"> Sample Output</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46"></a>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47"></a><span class="cm">   $ ./AssignStudentIDs.exe student-names.txt</span>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48"></a><span class="cm">   No of students         : 200</span>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49"></a><span class="cm">   Max threads            : 4</span>
</span><span id="__span-6-50"><a id="__codelineno-6-50" name="__codelineno-6-50"></a><span class="cm">   subArray size round up : 51</span>
</span><span id="__span-6-51"><a id="__codelineno-6-51" name="__codelineno-6-51"></a><span class="cm">   ---------------------------------</span>
</span><span id="__span-6-52"><a id="__codelineno-6-52" name="__codelineno-6-52"></a><span class="cm">   Thread created 25040</span>
</span><span id="__span-6-53"><a id="__codelineno-6-53" name="__codelineno-6-53"></a><span class="cm">   Thread created 26324</span>
</span><span id="__span-6-54"><a id="__codelineno-6-54" name="__codelineno-6-54"></a><span class="cm">   Thread created 11972</span>
</span><span id="__span-6-55"><a id="__codelineno-6-55" name="__codelineno-6-55"></a><span class="cm">   Thread created 26028</span>
</span><span id="__span-6-56"><a id="__codelineno-6-56" name="__codelineno-6-56"></a><span class="cm">   Starting threads ...</span>
</span><span id="__span-6-57"><a id="__codelineno-6-57" name="__codelineno-6-57"></a><span class="cm">   Waiting for threads to finish ...</span>
</span><span id="__span-6-58"><a id="__codelineno-6-58" name="__codelineno-6-58"></a><span class="cm">   All threads are done ...</span>
</span><span id="__span-6-59"><a id="__codelineno-6-59" name="__codelineno-6-59"></a><span class="cm">   Printing results ...</span>
</span><span id="__span-6-60"><a id="__codelineno-6-60" name="__codelineno-6-60"></a><span class="cm">   Alyssa Morgan, 200000</span>
</span><span id="__span-6-61"><a id="__codelineno-6-61" name="__codelineno-6-61"></a><span class="cm">   Declan Hayes, 200001</span>
</span><span id="__span-6-62"><a id="__codelineno-6-62" name="__codelineno-6-62"></a><span class="cm">   Nora Patel, 200002</span>
</span><span id="__span-6-63"><a id="__codelineno-6-63" name="__codelineno-6-63"></a><span class="cm">   Miles Thompson, 200003</span>
</span><span id="__span-6-64"><a id="__codelineno-6-64" name="__codelineno-6-64"></a><span class="cm">   Sienna Larson, 200004</span>
</span><span id="__span-6-65"><a id="__codelineno-6-65" name="__codelineno-6-65"></a><span class="cm">   Kellan Rivera, 200005</span>
</span><span id="__span-6-66"><a id="__codelineno-6-66" name="__codelineno-6-66"></a><span class="cm">   Camille Chang, 200006</span>
</span><span id="__span-6-67"><a id="__codelineno-6-67" name="__codelineno-6-67"></a><span class="cm">   Jensen Park, 200007</span>
</span><span id="__span-6-68"><a id="__codelineno-6-68" name="__codelineno-6-68"></a><span class="cm">   Amara Singh, 200008</span>
</span><span id="__span-6-69"><a id="__codelineno-6-69" name="__codelineno-6-69"></a><span class="cm">   Holden Myers, 200009</span>
</span><span id="__span-6-70"><a id="__codelineno-6-70" name="__codelineno-6-70"></a><span class="cm">   Elise Howard, 200010</span>
</span><span id="__span-6-71"><a id="__codelineno-6-71" name="__codelineno-6-71"></a><span class="cm">   Luca Griffin, 200011</span>
</span><span id="__span-6-72"><a id="__codelineno-6-72" name="__codelineno-6-72"></a><span class="cm">   Reagan Patel, 200012</span>
</span><span id="__span-6-73"><a id="__codelineno-6-73" name="__codelineno-6-73"></a><span class="cm">   ...</span>
</span><span id="__span-6-74"><a id="__codelineno-6-74" name="__codelineno-6-74"></a><span class="cm">   ...</span>
</span><span id="__span-6-75"><a id="__codelineno-6-75" name="__codelineno-6-75"></a>
</span><span id="__span-6-76"><a id="__codelineno-6-76" name="__codelineno-6-76"></a><span class="cm">}</span>
</span><span id="__span-6-77"><a id="__codelineno-6-77" name="__codelineno-6-77"></a>
</span><span id="__span-6-78"><a id="__codelineno-6-78" name="__codelineno-6-78"></a><span class="cm">{$mode objfpc}{$H+}{$J-}</span>
</span><span id="__span-6-79"><a id="__codelineno-6-79" name="__codelineno-6-79"></a>
</span><span id="__span-6-80"><a id="__codelineno-6-80" name="__codelineno-6-80"></a><span class="k">uses</span>
</span><span id="__span-6-81"><a id="__codelineno-6-81" name="__codelineno-6-81"></a><span class="w">  </span><span class="cm">{$IFDEF UNIX}</span>
</span><span id="__span-6-82"><a id="__codelineno-6-82" name="__codelineno-6-82"></a><span class="w">  </span><span class="n">cmem</span>
</span><span id="__span-6-83"><a id="__codelineno-6-83" name="__codelineno-6-83"></a><span class="w">  </span><span class="o">,</span><span class="w"> </span><span class="n">cthreads</span>
</span><span id="__span-6-84"><a id="__codelineno-6-84" name="__codelineno-6-84"></a><span class="w">  </span><span class="cm">{$ENDIF}</span>
</span><span id="__span-6-85"><a id="__codelineno-6-85" name="__codelineno-6-85"></a><span class="w">  </span><span class="n">Classes</span><span class="o">,</span>
</span><span id="__span-6-86"><a id="__codelineno-6-86" name="__codelineno-6-86"></a><span class="w">  </span><span class="n">SysUtils</span><span class="o">,</span>
</span><span id="__span-6-87"><a id="__codelineno-6-87" name="__codelineno-6-87"></a><span class="w">  </span><span class="n">Math</span><span class="o">,</span>
</span><span id="__span-6-88"><a id="__codelineno-6-88" name="__codelineno-6-88"></a><span class="w">  </span><span class="n">streamex</span><span class="o">,</span>
</span><span id="__span-6-89"><a id="__codelineno-6-89" name="__codelineno-6-89"></a><span class="w">  </span><span class="n">Common</span><span class="o">,</span>
</span><span id="__span-6-90"><a id="__codelineno-6-90" name="__codelineno-6-90"></a><span class="w">  </span><span class="n">CustomThread</span><span class="o">;</span>
</span><span id="__span-6-91"><a id="__codelineno-6-91" name="__codelineno-6-91"></a>
</span><span id="__span-6-92"><a id="__codelineno-6-92" name="__codelineno-6-92"></a><span class="w">  </span><span class="c1">// All the variables and procedures to get the job done.</span>
</span><span id="__span-6-93"><a id="__codelineno-6-93" name="__codelineno-6-93"></a><span class="k">var</span>
</span><span id="__span-6-94"><a id="__codelineno-6-94" name="__codelineno-6-94"></a><span class="w">  </span><span class="c1">// Critical Section preventing threads accessing a variable at the same time.</span>
</span><span id="__span-6-95"><a id="__codelineno-6-95" name="__codelineno-6-95"></a><span class="w">  </span><span class="n">customCriticalSection</span><span class="o">:</span><span class="w"> </span><span class="n">TRTLCriticalSection</span><span class="o">;</span>
</span><span id="__span-6-96"><a id="__codelineno-6-96" name="__codelineno-6-96"></a>
</span><span id="__span-6-97"><a id="__codelineno-6-97" name="__codelineno-6-97"></a><span class="w">  </span><span class="c1">// TStreams for reading files</span>
</span><span id="__span-6-98"><a id="__codelineno-6-98" name="__codelineno-6-98"></a><span class="w">  </span><span class="n">fileStream</span><span class="o">:</span><span class="w"> </span><span class="n">TFileStream</span><span class="o">;</span>
</span><span id="__span-6-99"><a id="__codelineno-6-99" name="__codelineno-6-99"></a><span class="w">  </span><span class="n">streamReader</span><span class="o">:</span><span class="w"> </span><span class="n">TStreamReader</span><span class="o">;</span>
</span><span id="__span-6-100"><a id="__codelineno-6-100" name="__codelineno-6-100"></a>
</span><span id="__span-6-101"><a id="__codelineno-6-101" name="__codelineno-6-101"></a><span class="w">  </span><span class="c1">// A temporary list to hold student names from a text file</span>
</span><span id="__span-6-102"><a id="__codelineno-6-102" name="__codelineno-6-102"></a><span class="w">  </span><span class="n">strList</span><span class="o">:</span><span class="w"> </span><span class="n">TStrList</span><span class="o">;</span>
</span><span id="__span-6-103"><a id="__codelineno-6-103" name="__codelineno-6-103"></a>
</span><span id="__span-6-104"><a id="__codelineno-6-104" name="__codelineno-6-104"></a><span class="w">  </span><span class="c1">// An array of threads</span>
</span><span id="__span-6-105"><a id="__codelineno-6-105" name="__codelineno-6-105"></a><span class="w">  </span><span class="n">myThreads</span><span class="o">:</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">TThread</span><span class="o">;</span>
</span><span id="__span-6-106"><a id="__codelineno-6-106" name="__codelineno-6-106"></a>
</span><span id="__span-6-107"><a id="__codelineno-6-107" name="__codelineno-6-107"></a><span class="w">  </span><span class="c1">// Variables for calculating subarray size for each thread</span>
</span><span id="__span-6-108"><a id="__codelineno-6-108" name="__codelineno-6-108"></a><span class="w">  </span><span class="n">subArraySize</span><span class="o">,</span><span class="w"> </span><span class="kp">index</span><span class="o">:</span><span class="w"> </span><span class="kt">int64</span><span class="o">;</span>
</span><span id="__span-6-109"><a id="__codelineno-6-109" name="__codelineno-6-109"></a>
</span><span id="__span-6-110"><a id="__codelineno-6-110" name="__codelineno-6-110"></a><span class="w">  </span><span class="c1">// Main block ////////////////////////////////////////////////////////////////</span>
</span><span id="__span-6-111"><a id="__codelineno-6-111" name="__codelineno-6-111"></a><span class="k">begin</span>
</span><span id="__span-6-112"><a id="__codelineno-6-112" name="__codelineno-6-112"></a><span class="w">  </span><span class="k">try</span>
</span><span id="__span-6-113"><a id="__codelineno-6-113" name="__codelineno-6-113"></a><span class="w">    </span><span class="c1">// 1. Read input text file and populate input array from a text file</span>
</span><span id="__span-6-114"><a id="__codelineno-6-114" name="__codelineno-6-114"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nb">FileExists</span><span class="p">(</span><span class="nb">ParamStr</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-6-115"><a id="__codelineno-6-115" name="__codelineno-6-115"></a><span class="w">    </span><span class="k">begin</span>
</span><span id="__span-6-116"><a id="__codelineno-6-116" name="__codelineno-6-116"></a><span class="w">      </span><span class="nb">WriteLn</span><span class="p">(</span><span class="nb">Format</span><span class="p">(</span><span class="s">'%s does not exist.'</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="nb">ParamStr</span><span class="p">(</span><span class="mi">1</span><span class="p">)]))</span><span class="o">;</span>
</span><span id="__span-6-117"><a id="__codelineno-6-117" name="__codelineno-6-117"></a><span class="w">      </span><span class="k">Exit</span><span class="o">;</span>
</span><span id="__span-6-118"><a id="__codelineno-6-118" name="__codelineno-6-118"></a><span class="w">    </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-6-119"><a id="__codelineno-6-119" name="__codelineno-6-119"></a>
</span><span id="__span-6-120"><a id="__codelineno-6-120" name="__codelineno-6-120"></a><span class="w">    </span><span class="n">strList</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TStrList</span><span class="o">.</span><span class="n">Create</span><span class="o">;</span>
</span><span id="__span-6-121"><a id="__codelineno-6-121" name="__codelineno-6-121"></a><span class="w">    </span><span class="n">finalStudentList</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TStudentList</span><span class="o">.</span><span class="n">Create</span><span class="o">;</span>
</span><span id="__span-6-122"><a id="__codelineno-6-122" name="__codelineno-6-122"></a><span class="w">    </span><span class="k">try</span>
</span><span id="__span-6-123"><a id="__codelineno-6-123" name="__codelineno-6-123"></a><span class="w">      </span><span class="n">fileStream</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TFileStream</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="nb">ParamStr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="n">fmOpenRead</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-124"><a id="__codelineno-6-124" name="__codelineno-6-124"></a><span class="w">      </span><span class="k">try</span>
</span><span id="__span-6-125"><a id="__codelineno-6-125" name="__codelineno-6-125"></a><span class="w">        </span><span class="n">streamReader</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TStreamReader</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">fileStream</span><span class="o">,</span><span class="w"> </span><span class="mi">65536</span><span class="o">,</span><span class="w"> </span><span class="k">False</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-126"><a id="__codelineno-6-126" name="__codelineno-6-126"></a><span class="w">        </span><span class="k">try</span>
</span><span id="__span-6-127"><a id="__codelineno-6-127" name="__codelineno-6-127"></a><span class="w">          </span><span class="k">while</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">streamReader</span><span class="o">.</span><span class="n">EOF</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-128"><a id="__codelineno-6-128" name="__codelineno-6-128"></a><span class="w">          </span><span class="k">begin</span>
</span><span id="__span-6-129"><a id="__codelineno-6-129" name="__codelineno-6-129"></a><span class="w">            </span><span class="c1">// Add each line into a list</span>
</span><span id="__span-6-130"><a id="__codelineno-6-130" name="__codelineno-6-130"></a><span class="w">            </span><span class="n">strList</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">streamReader</span><span class="o">.</span><span class="n">ReadLine</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-131"><a id="__codelineno-6-131" name="__codelineno-6-131"></a><span class="w">          </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-6-132"><a id="__codelineno-6-132" name="__codelineno-6-132"></a><span class="w">        </span><span class="k">finally</span>
</span><span id="__span-6-133"><a id="__codelineno-6-133" name="__codelineno-6-133"></a><span class="w">          </span><span class="n">streamReader</span><span class="o">.</span><span class="n">Free</span><span class="o">;</span>
</span><span id="__span-6-134"><a id="__codelineno-6-134" name="__codelineno-6-134"></a><span class="w">        </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-6-135"><a id="__codelineno-6-135" name="__codelineno-6-135"></a><span class="w">      </span><span class="k">finally</span>
</span><span id="__span-6-136"><a id="__codelineno-6-136" name="__codelineno-6-136"></a><span class="w">        </span><span class="n">fileStream</span><span class="o">.</span><span class="n">Free</span>
</span><span id="__span-6-137"><a id="__codelineno-6-137" name="__codelineno-6-137"></a><span class="w">      </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-6-138"><a id="__codelineno-6-138" name="__codelineno-6-138"></a>
</span><span id="__span-6-139"><a id="__codelineno-6-139" name="__codelineno-6-139"></a><span class="w">      </span><span class="c1">// 2. Init Critical Section as we have threads writing to a shared variable</span>
</span><span id="__span-6-140"><a id="__codelineno-6-140" name="__codelineno-6-140"></a><span class="w">      </span><span class="n">InitCriticalSection</span><span class="p">(</span><span class="n">customCriticalSection</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-141"><a id="__codelineno-6-141" name="__codelineno-6-141"></a>
</span><span id="__span-6-142"><a id="__codelineno-6-142" name="__codelineno-6-142"></a><span class="w">      </span><span class="c1">// 3a. set the number of threads in array of TThread</span>
</span><span id="__span-6-143"><a id="__codelineno-6-143" name="__codelineno-6-143"></a><span class="w">      </span><span class="nb">SetLength</span><span class="p">(</span><span class="n">myThreads</span><span class="o">,</span><span class="w"> </span><span class="n">maxThreads</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-144"><a id="__codelineno-6-144" name="__codelineno-6-144"></a><span class="w">      </span><span class="k">try</span>
</span><span id="__span-6-145"><a id="__codelineno-6-145" name="__codelineno-6-145"></a><span class="w">        </span><span class="cm">{</span>
</span><span id="__span-6-146"><a id="__codelineno-6-146" name="__codelineno-6-146"></a><span class="cm">          3b. Now we add threads &amp; assign workloads, using rounding up division --</span>
</span><span id="__span-6-147"><a id="__codelineno-6-147" name="__codelineno-6-147"></a><span class="cm">              Ceil((totalElements + N - 1) div N).</span>
</span><span id="__span-6-148"><a id="__codelineno-6-148" name="__codelineno-6-148"></a><span class="cm">              - When we divide totalElements by N, we get the quotient of the</span>
</span><span id="__span-6-149"><a id="__codelineno-6-149" name="__codelineno-6-149"></a><span class="cm">                division. However, if totalElements is not evenly divisible by N,</span>
</span><span id="__span-6-150"><a id="__codelineno-6-150" name="__codelineno-6-150"></a><span class="cm">                there might be a remainder.</span>
</span><span id="__span-6-151"><a id="__codelineno-6-151" name="__codelineno-6-151"></a><span class="cm">              - In the context of splitting an array into subarrays, we want</span>
</span><span id="__span-6-152"><a id="__codelineno-6-152" name="__codelineno-6-152"></a><span class="cm">                each subarray to have approximately the same number of elements.</span>
</span><span id="__span-6-153"><a id="__codelineno-6-153" name="__codelineno-6-153"></a><span class="cm">                Therefore, we want to ensure that any remaining elements after</span>
</span><span id="__span-6-154"><a id="__codelineno-6-154" name="__codelineno-6-154"></a><span class="cm">                dividing totalElements by N are included in the last subarray to</span>
</span><span id="__span-6-155"><a id="__codelineno-6-155" name="__codelineno-6-155"></a><span class="cm">                avoid losing data.</span>
</span><span id="__span-6-156"><a id="__codelineno-6-156" name="__codelineno-6-156"></a><span class="cm">              - The expression Ceil((totalElements + N - 1) div N); effectively</span>
</span><span id="__span-6-157"><a id="__codelineno-6-157" name="__codelineno-6-157"></a><span class="cm">                rounds up the division by adding N - 1 to totalElements before</span>
</span><span id="__span-6-158"><a id="__codelineno-6-158" name="__codelineno-6-158"></a><span class="cm">                performing the division. **This ensures that any remainder is</span>
</span><span id="__span-6-159"><a id="__codelineno-6-159" name="__codelineno-6-159"></a><span class="cm">                accounted for in the last subarray**.</span>
</span><span id="__span-6-160"><a id="__codelineno-6-160" name="__codelineno-6-160"></a><span class="cm">        }</span>
</span><span id="__span-6-161"><a id="__codelineno-6-161" name="__codelineno-6-161"></a><span class="w">        </span><span class="n">subArraySize</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">Math</span><span class="o">.</span><span class="n">Ceil</span><span class="p">((</span><span class="n">strList</span><span class="o">.</span><span class="n">Count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">maxThreads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">maxThreads</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-162"><a id="__codelineno-6-162" name="__codelineno-6-162"></a>
</span><span id="__span-6-163"><a id="__codelineno-6-163" name="__codelineno-6-163"></a><span class="w">        </span><span class="c1">// Show user feedback</span>
</span><span id="__span-6-164"><a id="__codelineno-6-164" name="__codelineno-6-164"></a><span class="w">        </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'No of students         : '</span><span class="o">,</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">strList</span><span class="o">.</span><span class="n">Count</span><span class="p">))</span><span class="o">;</span>
</span><span id="__span-6-165"><a id="__codelineno-6-165" name="__codelineno-6-165"></a><span class="w">        </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Max threads            : '</span><span class="o">,</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">maxThreads</span><span class="p">))</span><span class="o">;</span>
</span><span id="__span-6-166"><a id="__codelineno-6-166" name="__codelineno-6-166"></a><span class="w">        </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'subArray size round up : '</span><span class="o">,</span><span class="w"> </span><span class="nb">IntToStr</span><span class="p">(</span><span class="n">subArraySize</span><span class="p">))</span><span class="o">;</span>
</span><span id="__span-6-167"><a id="__codelineno-6-167" name="__codelineno-6-167"></a><span class="w">        </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'---------------------------------'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-168"><a id="__codelineno-6-168" name="__codelineno-6-168"></a>
</span><span id="__span-6-169"><a id="__codelineno-6-169" name="__codelineno-6-169"></a><span class="w">        </span><span class="cm">{</span>
</span><span id="__span-6-170"><a id="__codelineno-6-170" name="__codelineno-6-170"></a><span class="cm">         3c. Assign workload to each thread by using the following info;</span>
</span><span id="__span-6-171"><a id="__codelineno-6-171" name="__codelineno-6-171"></a><span class="cm">             - source list</span>
</span><span id="__span-6-172"><a id="__codelineno-6-172" name="__codelineno-6-172"></a><span class="cm">             - start index and</span>
</span><span id="__span-6-173"><a id="__codelineno-6-173" name="__codelineno-6-173"></a><span class="cm">             - finish index for a thread</span>
</span><span id="__span-6-174"><a id="__codelineno-6-174" name="__codelineno-6-174"></a><span class="cm">        }</span>
</span><span id="__span-6-175"><a id="__codelineno-6-175" name="__codelineno-6-175"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">maxThreads</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-176"><a id="__codelineno-6-176" name="__codelineno-6-176"></a><span class="w">        </span><span class="k">begin</span>
</span><span id="__span-6-177"><a id="__codelineno-6-177" name="__codelineno-6-177"></a><span class="w">          </span><span class="n">myThreads</span><span class="p">[</span><span class="kp">index</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TCustomThread</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">customCriticalSection</span><span class="o">,</span>
</span><span id="__span-6-178"><a id="__codelineno-6-178" name="__codelineno-6-178"></a><span class="w">                                                       </span><span class="n">strList</span><span class="o">,</span>
</span><span id="__span-6-179"><a id="__codelineno-6-179" name="__codelineno-6-179"></a><span class="w">                                                       </span><span class="p">((</span><span class="kp">index</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">subArraySize</span><span class="p">)</span><span class="o">,</span>
</span><span id="__span-6-180"><a id="__codelineno-6-180" name="__codelineno-6-180"></a><span class="w">                                                       </span><span class="n">Math</span><span class="o">.</span><span class="n">Min</span><span class="p">(</span><span class="kp">index</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">subArraySize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">,</span><span class="w"> </span><span class="n">strList</span><span class="o">.</span><span class="n">Count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="o">;</span>
</span><span id="__span-6-181"><a id="__codelineno-6-181" name="__codelineno-6-181"></a><span class="w">        </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-6-182"><a id="__codelineno-6-182" name="__codelineno-6-182"></a>
</span><span id="__span-6-183"><a id="__codelineno-6-183" name="__codelineno-6-183"></a><span class="w">        </span><span class="c1">// 4. Start all threads</span>
</span><span id="__span-6-184"><a id="__codelineno-6-184" name="__codelineno-6-184"></a><span class="w">        </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Starting threads ...'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-185"><a id="__codelineno-6-185" name="__codelineno-6-185"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nb">High</span><span class="p">(</span><span class="n">myThreads</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-186"><a id="__codelineno-6-186" name="__codelineno-6-186"></a><span class="w">          </span><span class="n">myThreads</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">.</span><span class="n">Start</span><span class="o">;</span>
</span><span id="__span-6-187"><a id="__codelineno-6-187" name="__codelineno-6-187"></a>
</span><span id="__span-6-188"><a id="__codelineno-6-188" name="__codelineno-6-188"></a><span class="w">        </span><span class="c1">// 5. Wait for both threads to finish and free</span>
</span><span id="__span-6-189"><a id="__codelineno-6-189" name="__codelineno-6-189"></a><span class="w">        </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Waiting for threads to finish ...'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-190"><a id="__codelineno-6-190" name="__codelineno-6-190"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="nb">High</span><span class="p">(</span><span class="n">myThreads</span><span class="p">)</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-191"><a id="__codelineno-6-191" name="__codelineno-6-191"></a><span class="w">          </span><span class="k">begin</span>
</span><span id="__span-6-192"><a id="__codelineno-6-192" name="__codelineno-6-192"></a><span class="w">            </span><span class="n">myThreads</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">.</span><span class="n">WaitFor</span><span class="o">;</span>
</span><span id="__span-6-193"><a id="__codelineno-6-193" name="__codelineno-6-193"></a><span class="w">            </span><span class="n">myThreads</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">.</span><span class="n">Free</span><span class="o">;</span>
</span><span id="__span-6-194"><a id="__codelineno-6-194" name="__codelineno-6-194"></a><span class="w">          </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-6-195"><a id="__codelineno-6-195" name="__codelineno-6-195"></a><span class="w">        </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'All threads are done ...'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-196"><a id="__codelineno-6-196" name="__codelineno-6-196"></a>
</span><span id="__span-6-197"><a id="__codelineno-6-197" name="__codelineno-6-197"></a><span class="w">        </span><span class="c1">// 6. Sort by student ID</span>
</span><span id="__span-6-198"><a id="__codelineno-6-198" name="__codelineno-6-198"></a><span class="w">        </span><span class="n">finalStudentList</span><span class="o">.</span><span class="n">Sort</span><span class="p">(</span><span class="n">TStudentListComparer</span><span class="o">.</span><span class="n">construct</span><span class="p">(</span><span class="o">@</span><span class="n">CompareID</span><span class="p">))</span><span class="o">;</span>
</span><span id="__span-6-199"><a id="__codelineno-6-199" name="__codelineno-6-199"></a>
</span><span id="__span-6-200"><a id="__codelineno-6-200" name="__codelineno-6-200"></a><span class="w">        </span><span class="c1">// 7. Show results</span>
</span><span id="__span-6-201"><a id="__codelineno-6-201" name="__codelineno-6-201"></a><span class="w">        </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Printing results ...'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-202"><a id="__codelineno-6-202" name="__codelineno-6-202"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">finalStudentList</span><span class="o">.</span><span class="n">Count</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-203"><a id="__codelineno-6-203" name="__codelineno-6-203"></a><span class="w">          </span><span class="nb">WriteLn</span><span class="p">(</span><span class="n">finalStudentList</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">.</span><span class="n">Name</span><span class="o">,</span><span class="w"> </span><span class="s">', '</span><span class="o">,</span><span class="w"> </span><span class="n">finalStudentList</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-204"><a id="__codelineno-6-204" name="__codelineno-6-204"></a>
</span><span id="__span-6-205"><a id="__codelineno-6-205" name="__codelineno-6-205"></a><span class="w">        </span><span class="c1">// 8. Show user feedback</span>
</span><span id="__span-6-206"><a id="__codelineno-6-206" name="__codelineno-6-206"></a><span class="w">        </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'---------------------------------'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-207"><a id="__codelineno-6-207" name="__codelineno-6-207"></a><span class="w">        </span><span class="nb">WriteLn</span><span class="p">(</span><span class="nb">Format</span><span class="p">(</span><span class="s">'Output list contains %d items'</span><span class="o">,</span><span class="w"> </span><span class="p">[</span><span class="n">finalStudentList</span><span class="o">.</span><span class="n">Count</span><span class="p">]))</span><span class="o">;</span>
</span><span id="__span-6-208"><a id="__codelineno-6-208" name="__codelineno-6-208"></a><span class="w">        </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'---------------------------------'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-209"><a id="__codelineno-6-209" name="__codelineno-6-209"></a><span class="w">      </span><span class="k">finally</span>
</span><span id="__span-6-210"><a id="__codelineno-6-210" name="__codelineno-6-210"></a><span class="w">        </span><span class="c1">// 7. Free Critical Section</span>
</span><span id="__span-6-211"><a id="__codelineno-6-211" name="__codelineno-6-211"></a><span class="w">        </span><span class="n">DoneCriticalSection</span><span class="p">(</span><span class="n">customCriticalSection</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-212"><a id="__codelineno-6-212" name="__codelineno-6-212"></a><span class="w">      </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-6-213"><a id="__codelineno-6-213" name="__codelineno-6-213"></a><span class="w">    </span><span class="k">finally</span>
</span><span id="__span-6-214"><a id="__codelineno-6-214" name="__codelineno-6-214"></a><span class="w">      </span><span class="n">finalStudentList</span><span class="o">.</span><span class="n">Free</span><span class="o">;</span>
</span><span id="__span-6-215"><a id="__codelineno-6-215" name="__codelineno-6-215"></a><span class="w">      </span><span class="n">strList</span><span class="o">.</span><span class="n">Free</span><span class="o">;</span>
</span><span id="__span-6-216"><a id="__codelineno-6-216" name="__codelineno-6-216"></a><span class="w">    </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-6-217"><a id="__codelineno-6-217" name="__codelineno-6-217"></a>
</span><span id="__span-6-218"><a id="__codelineno-6-218" name="__codelineno-6-218"></a><span class="w">  </span><span class="k">except</span>
</span><span id="__span-6-219"><a id="__codelineno-6-219" name="__codelineno-6-219"></a><span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">E</span><span class="o">:</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-6-220"><a id="__codelineno-6-220" name="__codelineno-6-220"></a><span class="w">      </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'Error: '</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">E</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-6-221"><a id="__codelineno-6-221" name="__codelineno-6-221"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-6-222"><a id="__codelineno-6-222" name="__codelineno-6-222"></a><span class="k">end</span><span class="o">.</span>
</span></code></pre></div></td></tr></tbody></table></div>
<h2 id="a-large-text-file-parser">A Large Text File Parser<a class="headerlink" href="#a-large-text-file-parser" title="Permanent link">¶</a></h2>
<p>This example demonstrates how to parse a text file using multi-threading. The code reads the text file, divides it into chunks, and assigns each chunk to a different thread. Each thread then prints the number of bytes it processed and the first line of its chunk.</p>
<div class="language-pascal highlight"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">  1</a></span>
<span class="normal"><a href="#__codelineno-7-2">  2</a></span>
<span class="normal"><a href="#__codelineno-7-3">  3</a></span>
<span class="normal"><a href="#__codelineno-7-4">  4</a></span>
<span class="normal"><a href="#__codelineno-7-5">  5</a></span>
<span class="normal"><a href="#__codelineno-7-6">  6</a></span>
<span class="normal"><a href="#__codelineno-7-7">  7</a></span>
<span class="normal"><a href="#__codelineno-7-8">  8</a></span>
<span class="normal"><a href="#__codelineno-7-9">  9</a></span>
<span class="normal"><a href="#__codelineno-7-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-7-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-7-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-7-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-7-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-7-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-7-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-7-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-7-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-7-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-7-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-7-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-7-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-7-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-7-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-7-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-7-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-7-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-7-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-7-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-7-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-7-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-7-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-7-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-7-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-7-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-7-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-7-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-7-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-7-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-7-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-7-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-7-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-7-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-7-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-7-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-7-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-7-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-7-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-7-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-7-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-7-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-7-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-7-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-7-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-7-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-7-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-7-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-7-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-7-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-7-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-7-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-7-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-7-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-7-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-7-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-7-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-7-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-7-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-7-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-7-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-7-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-7-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-7-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-7-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-7-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-7-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-7-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-7-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-7-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-7-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-7-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-7-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-7-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-7-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-7-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-7-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-7-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-7-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-7-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-7-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-7-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-7-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-7-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-7-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-7-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-7-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-7-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-7-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-7-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-7-100">100</a></span>
<span class="normal"><a href="#__codelineno-7-101">101</a></span>
<span class="normal"><a href="#__codelineno-7-102">102</a></span>
<span class="normal"><a href="#__codelineno-7-103">103</a></span>
<span class="normal"><a href="#__codelineno-7-104">104</a></span>
<span class="normal"><a href="#__codelineno-7-105">105</a></span>
<span class="normal"><a href="#__codelineno-7-106">106</a></span>
<span class="normal"><a href="#__codelineno-7-107">107</a></span>
<span class="normal"><a href="#__codelineno-7-108">108</a></span>
<span class="normal"><a href="#__codelineno-7-109">109</a></span>
<span class="normal"><a href="#__codelineno-7-110">110</a></span>
<span class="normal"><a href="#__codelineno-7-111">111</a></span>
<span class="normal"><a href="#__codelineno-7-112">112</a></span>
<span class="normal"><a href="#__codelineno-7-113">113</a></span>
<span class="normal"><a href="#__codelineno-7-114">114</a></span>
<span class="normal"><a href="#__codelineno-7-115">115</a></span>
<span class="normal"><a href="#__codelineno-7-116">116</a></span>
<span class="normal"><a href="#__codelineno-7-117">117</a></span>
<span class="normal"><a href="#__codelineno-7-118">118</a></span>
<span class="normal"><a href="#__codelineno-7-119">119</a></span>
<span class="normal"><a href="#__codelineno-7-120">120</a></span>
<span class="normal"><a href="#__codelineno-7-121">121</a></span>
<span class="normal"><a href="#__codelineno-7-122">122</a></span>
<span class="normal"><a href="#__codelineno-7-123">123</a></span>
<span class="normal"><a href="#__codelineno-7-124">124</a></span>
<span class="normal"><a href="#__codelineno-7-125">125</a></span>
<span class="normal"><a href="#__codelineno-7-126">126</a></span>
<span class="normal"><a href="#__codelineno-7-127">127</a></span>
<span class="normal"><a href="#__codelineno-7-128">128</a></span>
<span class="normal"><a href="#__codelineno-7-129">129</a></span>
<span class="normal"><a href="#__codelineno-7-130">130</a></span>
<span class="normal"><a href="#__codelineno-7-131">131</a></span>
<span class="normal"><a href="#__codelineno-7-132">132</a></span>
<span class="normal"><a href="#__codelineno-7-133">133</a></span>
<span class="normal"><a href="#__codelineno-7-134">134</a></span>
<span class="normal"><a href="#__codelineno-7-135">135</a></span>
<span class="normal"><a href="#__codelineno-7-136">136</a></span>
<span class="normal"><a href="#__codelineno-7-137">137</a></span>
<span class="normal"><a href="#__codelineno-7-138">138</a></span>
<span class="normal"><a href="#__codelineno-7-139">139</a></span>
<span class="normal"><a href="#__codelineno-7-140">140</a></span>
<span class="normal"><a href="#__codelineno-7-141">141</a></span>
<span class="normal"><a href="#__codelineno-7-142">142</a></span>
<span class="normal"><a href="#__codelineno-7-143">143</a></span>
<span class="normal"><a href="#__codelineno-7-144">144</a></span>
<span class="normal"><a href="#__codelineno-7-145">145</a></span>
<span class="normal"><a href="#__codelineno-7-146">146</a></span>
<span class="normal"><a href="#__codelineno-7-147">147</a></span>
<span class="normal"><a href="#__codelineno-7-148">148</a></span>
<span class="normal"><a href="#__codelineno-7-149">149</a></span>
<span class="normal"><a href="#__codelineno-7-150">150</a></span>
<span class="normal"><a href="#__codelineno-7-151">151</a></span>
<span class="normal"><a href="#__codelineno-7-152">152</a></span>
<span class="normal"><a href="#__codelineno-7-153">153</a></span>
<span class="normal"><a href="#__codelineno-7-154">154</a></span>
<span class="normal"><a href="#__codelineno-7-155">155</a></span>
<span class="normal"><a href="#__codelineno-7-156">156</a></span>
<span class="normal"><a href="#__codelineno-7-157">157</a></span>
<span class="normal"><a href="#__codelineno-7-158">158</a></span>
<span class="normal"><a href="#__codelineno-7-159">159</a></span>
<span class="normal"><a href="#__codelineno-7-160">160</a></span>
<span class="normal"><a href="#__codelineno-7-161">161</a></span>
<span class="normal"><a href="#__codelineno-7-162">162</a></span>
<span class="normal"><a href="#__codelineno-7-163">163</a></span>
<span class="normal"><a href="#__codelineno-7-164">164</a></span>
<span class="normal"><a href="#__codelineno-7-165">165</a></span>
<span class="normal"><a href="#__codelineno-7-166">166</a></span>
<span class="normal"><a href="#__codelineno-7-167">167</a></span>
<span class="normal"><a href="#__codelineno-7-168">168</a></span>
<span class="normal"><a href="#__codelineno-7-169">169</a></span>
<span class="normal"><a href="#__codelineno-7-170">170</a></span>
<span class="normal"><a href="#__codelineno-7-171">171</a></span>
<span class="normal"><a href="#__codelineno-7-172">172</a></span>
<span class="normal"><a href="#__codelineno-7-173">173</a></span>
<span class="normal"><a href="#__codelineno-7-174">174</a></span>
<span class="normal"><a href="#__codelineno-7-175">175</a></span>
<span class="normal"><a href="#__codelineno-7-176">176</a></span>
<span class="normal"><a href="#__codelineno-7-177">177</a></span>
<span class="normal"><a href="#__codelineno-7-178">178</a></span>
<span class="normal"><a href="#__codelineno-7-179">179</a></span>
<span class="normal"><a href="#__codelineno-7-180">180</a></span>
<span class="normal"><a href="#__codelineno-7-181">181</a></span>
<span class="normal"><a href="#__codelineno-7-182">182</a></span>
<span class="normal"><a href="#__codelineno-7-183">183</a></span>
<span class="normal"><a href="#__codelineno-7-184">184</a></span>
<span class="normal"><a href="#__codelineno-7-185">185</a></span>
<span class="normal"><a href="#__codelineno-7-186">186</a></span>
<span class="normal"><a href="#__codelineno-7-187">187</a></span>
<span class="normal"><a href="#__codelineno-7-188">188</a></span>
<span class="normal"><a href="#__codelineno-7-189">189</a></span>
<span class="normal"><a href="#__codelineno-7-190">190</a></span>
<span class="normal"><a href="#__codelineno-7-191">191</a></span>
<span class="normal"><a href="#__codelineno-7-192">192</a></span>
<span class="normal"><a href="#__codelineno-7-193">193</a></span>
<span class="normal"><a href="#__codelineno-7-194">194</a></span>
<span class="normal"><a href="#__codelineno-7-195">195</a></span>
<span class="normal"><a href="#__codelineno-7-196">196</a></span>
<span class="normal"><a href="#__codelineno-7-197">197</a></span>
<span class="normal"><a href="#__codelineno-7-198">198</a></span>
<span class="normal"><a href="#__codelineno-7-199">199</a></span>
<span class="normal"><a href="#__codelineno-7-200">200</a></span>
<span class="normal"><a href="#__codelineno-7-201">201</a></span>
<span class="normal"><a href="#__codelineno-7-202">202</a></span>
<span class="normal"><a href="#__codelineno-7-203">203</a></span>
<span class="normal"><a href="#__codelineno-7-204">204</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="k">program</span><span class="w"> </span><span class="n">LargeTextFileParser</span><span class="o">;</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="cm">{</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="cm"> Description</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="cm"> This program is a simple example of parsing of a text file using N threads.</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="cm"> The code reads and divides the text file into chunks and assigns these chunks</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="cm"> to different threads, ensuring that no chunk splits a paragraph or sentence.</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="cm"> Workflow</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a>
</span><span id="__span-7-12"><a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="cm"> 1. File Reading      - Read the file in 12MB chunks.</span>
</span><span id="__span-7-13"><a id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="cm"> 2. Data Integrity    - Ensure chunks do not split paragraphs or sentences by</span>
</span><span id="__span-7-14"><a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="cm">                        adjusting the file pointer based on the last newline</span>
</span><span id="__span-7-15"><a id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="cm">                        character.</span>
</span><span id="__span-7-16"><a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="cm"> 3. Thread Management - Use up to N threads to process chunks in parallel.</span>
</span><span id="__span-7-17"><a id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="cm"> 4. Display Output    - Print the size of each chunk and the first line of each chunk.</span>
</span><span id="__span-7-18"><a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="cm">}</span>
</span><span id="__span-7-19"><a id="__codelineno-7-19" name="__codelineno-7-19"></a>
</span><span id="__span-7-20"><a id="__codelineno-7-20" name="__codelineno-7-20"></a><span class="cm">{$mode objfpc}{$H+}{$J-}</span>
</span><span id="__span-7-21"><a id="__codelineno-7-21" name="__codelineno-7-21"></a>
</span><span id="__span-7-22"><a id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="k">uses</span>
</span><span id="__span-7-23"><a id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">  </span><span class="n">Classes</span><span class="o">,</span>
</span><span id="__span-7-24"><a id="__codelineno-7-24" name="__codelineno-7-24"></a><span class="w">  </span><span class="n">SysUtils</span><span class="o">,</span>
</span><span id="__span-7-25"><a id="__codelineno-7-25" name="__codelineno-7-25"></a><span class="w">  </span><span class="n">Math</span><span class="o">;</span>
</span><span id="__span-7-26"><a id="__codelineno-7-26" name="__codelineno-7-26"></a>
</span><span id="__span-7-27"><a id="__codelineno-7-27" name="__codelineno-7-27"></a><span class="k">const</span>
</span><span id="__span-7-28"><a id="__codelineno-7-28" name="__codelineno-7-28"></a><span class="w">  </span><span class="n">MAX_THREADS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="o">;</span><span class="w"> </span><span class="c1">// Max threads to use</span>
</span><span id="__span-7-29"><a id="__codelineno-7-29" name="__codelineno-7-29"></a><span class="w">  </span><span class="n">CHUNK_SIZE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="o">;</span><span class="w"> </span><span class="c1">// Size of chunk for each thread to process (12MB)</span>
</span><span id="__span-7-30"><a id="__codelineno-7-30" name="__codelineno-7-30"></a>
</span><span id="__span-7-31"><a id="__codelineno-7-31" name="__codelineno-7-31"></a><span class="k">type</span>
</span><span id="__span-7-32"><a id="__codelineno-7-32" name="__codelineno-7-32"></a><span class="w">  </span><span class="c1">// The TThread class encapsulates the native thread support of the OS.</span>
</span><span id="__span-7-33"><a id="__codelineno-7-33" name="__codelineno-7-33"></a><span class="w">  </span><span class="n">TFileChunkProcessor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">class</span><span class="p">(</span><span class="n">TThread</span><span class="p">)</span>
</span><span id="__span-7-34"><a id="__codelineno-7-34" name="__codelineno-7-34"></a><span class="w">  </span><span class="kp">private</span>
</span><span id="__span-7-35"><a id="__codelineno-7-35" name="__codelineno-7-35"></a><span class="w">    </span><span class="n">FData</span><span class="o">:</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="kt">char</span><span class="o">;</span><span class="w"> </span><span class="c1">// Chunk of data to work with</span>
</span><span id="__span-7-36"><a id="__codelineno-7-36" name="__codelineno-7-36"></a><span class="w">    </span><span class="n">FDataSize</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span><span class="w">   </span><span class="c1">// Length of data to the nearest new line</span>
</span><span id="__span-7-37"><a id="__codelineno-7-37" name="__codelineno-7-37"></a><span class="w">  </span><span class="kp">protected</span>
</span><span id="__span-7-38"><a id="__codelineno-7-38" name="__codelineno-7-38"></a><span class="w">    </span><span class="k">procedure</span><span class="w"> </span><span class="nf">Execute</span><span class="o">;</span><span class="w"> </span><span class="kp">override</span><span class="o">;</span>
</span><span id="__span-7-39"><a id="__codelineno-7-39" name="__codelineno-7-39"></a><span class="w">  </span><span class="kp">public</span>
</span><span id="__span-7-40"><a id="__codelineno-7-40" name="__codelineno-7-40"></a><span class="w">    </span><span class="k">constructor</span><span class="w"> </span><span class="nf">Create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">AData</span><span class="o">:</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="kt">char</span><span class="o">;</span><span class="w"> </span><span class="n">ADataSize</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-41"><a id="__codelineno-7-41" name="__codelineno-7-41"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-42"><a id="__codelineno-7-42" name="__codelineno-7-42"></a>
</span><span id="__span-7-43"><a id="__codelineno-7-43" name="__codelineno-7-43"></a><span class="w">  </span><span class="k">constructor</span><span class="w"> </span><span class="nc">TFileChunkProcessor</span><span class="o">.</span><span class="nf">Create</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">AData</span><span class="o">:</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="kt">char</span><span class="o">;</span><span class="w"> </span><span class="n">ADataSize</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-44"><a id="__codelineno-7-44" name="__codelineno-7-44"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-7-45"><a id="__codelineno-7-45" name="__codelineno-7-45"></a><span class="w">    </span><span class="c1">// Call parent's constructor and don't start thread automatically</span>
</span><span id="__span-7-46"><a id="__codelineno-7-46" name="__codelineno-7-46"></a><span class="w">    </span><span class="k">inherited</span><span class="w"> </span><span class="n">Create</span><span class="p">(</span><span class="k">True</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-47"><a id="__codelineno-7-47" name="__codelineno-7-47"></a>
</span><span id="__span-7-48"><a id="__codelineno-7-48" name="__codelineno-7-48"></a><span class="w">    </span><span class="c1">// Assign a AData size to work with</span>
</span><span id="__span-7-49"><a id="__codelineno-7-49" name="__codelineno-7-49"></a><span class="w">    </span><span class="n">FDataSize</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">ADataSize</span><span class="o">;</span>
</span><span id="__span-7-50"><a id="__codelineno-7-50" name="__codelineno-7-50"></a>
</span><span id="__span-7-51"><a id="__codelineno-7-51" name="__codelineno-7-51"></a><span class="w">    </span><span class="c1">// Allocate memory for AData and copy it</span>
</span><span id="__span-7-52"><a id="__codelineno-7-52" name="__codelineno-7-52"></a><span class="w">    </span><span class="c1">// Since Char in Free Pascal can be 1 or 2 bytes (depending on whether</span>
</span><span id="__span-7-53"><a id="__codelineno-7-53" name="__codelineno-7-53"></a><span class="w">    </span><span class="c1">// it's an ANSI or Unicode character), using SizeOf(Char) ensures</span>
</span><span id="__span-7-54"><a id="__codelineno-7-54" name="__codelineno-7-54"></a><span class="w">    </span><span class="c1">// the correct number of bytes are moved</span>
</span><span id="__span-7-55"><a id="__codelineno-7-55" name="__codelineno-7-55"></a><span class="w">    </span><span class="nb">SetLength</span><span class="p">(</span><span class="n">FData</span><span class="o">,</span><span class="w"> </span><span class="n">FDataSize</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-56"><a id="__codelineno-7-56" name="__codelineno-7-56"></a><span class="w">    </span><span class="nb">Move</span><span class="p">(</span><span class="n">AData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">,</span><span class="w"> </span><span class="n">FData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">,</span><span class="w"> </span><span class="n">FDataSize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">SizeOf</span><span class="p">(</span><span class="kt">char</span><span class="p">))</span><span class="o">;</span>
</span><span id="__span-7-57"><a id="__codelineno-7-57" name="__codelineno-7-57"></a>
</span><span id="__span-7-58"><a id="__codelineno-7-58" name="__codelineno-7-58"></a><span class="w">    </span><span class="c1">// Do not free thread automatically when finished.</span>
</span><span id="__span-7-59"><a id="__codelineno-7-59" name="__codelineno-7-59"></a><span class="w">    </span><span class="n">FreeOnTerminate</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">False</span><span class="o">;</span>
</span><span id="__span-7-60"><a id="__codelineno-7-60" name="__codelineno-7-60"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-61"><a id="__codelineno-7-61" name="__codelineno-7-61"></a>
</span><span id="__span-7-62"><a id="__codelineno-7-62" name="__codelineno-7-62"></a><span class="w">  </span><span class="k">procedure</span><span class="w"> </span><span class="nc">TFileChunkProcessor</span><span class="o">.</span><span class="nf">Execute</span><span class="o">;</span>
</span><span id="__span-7-63"><a id="__codelineno-7-63" name="__codelineno-7-63"></a><span class="w">  </span><span class="k">var</span>
</span><span id="__span-7-64"><a id="__codelineno-7-64" name="__codelineno-7-64"></a><span class="w">    </span><span class="n">line</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="o">;</span>
</span><span id="__span-7-65"><a id="__codelineno-7-65" name="__codelineno-7-65"></a><span class="w">    </span><span class="kp">index</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-7-66"><a id="__codelineno-7-66" name="__codelineno-7-66"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-7-67"><a id="__codelineno-7-67" name="__codelineno-7-67"></a><span class="w">    </span><span class="c1">// Example processing: print the chunk size and the first line</span>
</span><span id="__span-7-68"><a id="__codelineno-7-68" name="__codelineno-7-68"></a><span class="w">    </span><span class="n">line</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">''</span><span class="o">;</span>
</span><span id="__span-7-69"><a id="__codelineno-7-69" name="__codelineno-7-69"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">FDataSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-7-70"><a id="__codelineno-7-70" name="__codelineno-7-70"></a><span class="w">    </span><span class="k">begin</span>
</span><span id="__span-7-71"><a id="__codelineno-7-71" name="__codelineno-7-71"></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">FData</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">#10</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-7-72"><a id="__codelineno-7-72" name="__codelineno-7-72"></a><span class="w">      </span><span class="k">begin</span>
</span><span id="__span-7-73"><a id="__codelineno-7-73" name="__codelineno-7-73"></a><span class="w">        </span><span class="nb">Writeln</span><span class="p">(</span><span class="s">'Processed chunk of size: '</span><span class="o">,</span><span class="w"> </span><span class="n">FDataSize</span><span class="o">,</span><span class="w"> </span><span class="s">' bytes'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-74"><a id="__codelineno-7-74" name="__codelineno-7-74"></a><span class="w">        </span><span class="nb">Writeln</span><span class="p">(</span><span class="s">'First line: '</span><span class="o">,</span><span class="w"> </span><span class="n">line</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-75"><a id="__codelineno-7-75" name="__codelineno-7-75"></a><span class="w">        </span><span class="k">Break</span><span class="o">;</span>
</span><span id="__span-7-76"><a id="__codelineno-7-76" name="__codelineno-7-76"></a><span class="w">      </span><span class="k">end</span>
</span><span id="__span-7-77"><a id="__codelineno-7-77" name="__codelineno-7-77"></a><span class="w">      </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">FData</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&gt;</span><span class="w"> </span><span class="sc">#13</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-7-78"><a id="__codelineno-7-78" name="__codelineno-7-78"></a><span class="w">      </span><span class="k">begin</span>
</span><span id="__span-7-79"><a id="__codelineno-7-79" name="__codelineno-7-79"></a><span class="w">        </span><span class="n">line</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">line</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">FData</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">;</span>
</span><span id="__span-7-80"><a id="__codelineno-7-80" name="__codelineno-7-80"></a><span class="w">      </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-81"><a id="__codelineno-7-81" name="__codelineno-7-81"></a><span class="w">    </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-82"><a id="__codelineno-7-82" name="__codelineno-7-82"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-83"><a id="__codelineno-7-83" name="__codelineno-7-83"></a>
</span><span id="__span-7-84"><a id="__codelineno-7-84" name="__codelineno-7-84"></a><span class="w">  </span><span class="cm">{</span>
</span><span id="__span-7-85"><a id="__codelineno-7-85" name="__codelineno-7-85"></a><span class="cm">   This routine reads a text file in chunks and processes each chunk using</span>
</span><span id="__span-7-86"><a id="__codelineno-7-86" name="__codelineno-7-86"></a><span class="cm">   separate threads. It ensures each thread processes a chunk up to the</span>
</span><span id="__span-7-87"><a id="__codelineno-7-87" name="__codelineno-7-87"></a><span class="cm">   nearest newline, without breaking a paragraph or sentence.</span>
</span><span id="__span-7-88"><a id="__codelineno-7-88" name="__codelineno-7-88"></a><span class="cm">  }</span>
</span><span id="__span-7-89"><a id="__codelineno-7-89" name="__codelineno-7-89"></a><span class="w">  </span><span class="k">procedure</span><span class="w"> </span><span class="nf">ReadFileInChunks</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">AFileName</span><span class="o">:</span><span class="w"> </span><span class="k">string</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-90"><a id="__codelineno-7-90" name="__codelineno-7-90"></a><span class="w">  </span><span class="k">var</span>
</span><span id="__span-7-91"><a id="__codelineno-7-91" name="__codelineno-7-91"></a><span class="w">    </span><span class="n">fStream</span><span class="o">:</span><span class="w"> </span><span class="n">TFileStream</span><span class="o">;</span>
</span><span id="__span-7-92"><a id="__codelineno-7-92" name="__codelineno-7-92"></a><span class="w">    </span><span class="n">buffer</span><span class="o">:</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="kt">char</span><span class="o">;</span>
</span><span id="__span-7-93"><a id="__codelineno-7-93" name="__codelineno-7-93"></a><span class="w">    </span><span class="n">bufferSize</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-7-94"><a id="__codelineno-7-94" name="__codelineno-7-94"></a><span class="w">    </span><span class="kp">index</span><span class="o">,</span><span class="w"> </span><span class="n">lastNewLine</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-7-95"><a id="__codelineno-7-95" name="__codelineno-7-95"></a><span class="w">    </span><span class="n">threadList</span><span class="o">:</span><span class="w"> </span><span class="k">array</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">TFileChunkProcessor</span><span class="o">;</span>
</span><span id="__span-7-96"><a id="__codelineno-7-96" name="__codelineno-7-96"></a><span class="w">    </span><span class="n">activeThreads</span><span class="o">:</span><span class="w"> </span><span class="kt">integer</span><span class="o">;</span>
</span><span id="__span-7-97"><a id="__codelineno-7-97" name="__codelineno-7-97"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-7-98"><a id="__codelineno-7-98" name="__codelineno-7-98"></a><span class="w">    </span><span class="n">fStream</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TFileStream</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">AFileName</span><span class="o">,</span><span class="w"> </span><span class="n">fmOpenRead</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-99"><a id="__codelineno-7-99" name="__codelineno-7-99"></a><span class="w">    </span><span class="k">try</span>
</span><span id="__span-7-100"><a id="__codelineno-7-100" name="__codelineno-7-100"></a>
</span><span id="__span-7-101"><a id="__codelineno-7-101" name="__codelineno-7-101"></a><span class="w">      </span><span class="c1">// Initialise variables for buffer, threads and threads counter.</span>
</span><span id="__span-7-102"><a id="__codelineno-7-102" name="__codelineno-7-102"></a><span class="w">      </span><span class="nb">SetLength</span><span class="p">(</span><span class="n">buffer</span><span class="o">,</span><span class="w"> </span><span class="n">CHUNK_SIZE</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-103"><a id="__codelineno-7-103" name="__codelineno-7-103"></a><span class="w">      </span><span class="nb">SetLength</span><span class="p">(</span><span class="n">threadList</span><span class="o">,</span><span class="w"> </span><span class="n">MAX_THREADS</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-104"><a id="__codelineno-7-104" name="__codelineno-7-104"></a><span class="w">      </span><span class="n">activeThreads</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
</span><span id="__span-7-105"><a id="__codelineno-7-105" name="__codelineno-7-105"></a>
</span><span id="__span-7-106"><a id="__codelineno-7-106" name="__codelineno-7-106"></a><span class="w">      </span><span class="c1">// Read the file until the file pointer reaches the end of the file</span>
</span><span id="__span-7-107"><a id="__codelineno-7-107" name="__codelineno-7-107"></a><span class="w">      </span><span class="k">while</span><span class="w"> </span><span class="n">fStream</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">fStream</span><span class="o">.</span><span class="n">Size</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-7-108"><a id="__codelineno-7-108" name="__codelineno-7-108"></a><span class="w">      </span><span class="k">begin</span>
</span><span id="__span-7-109"><a id="__codelineno-7-109" name="__codelineno-7-109"></a><span class="w">        </span><span class="c1">// Determine the buffer size to read and ensuring that the buffer size</span>
</span><span id="__span-7-110"><a id="__codelineno-7-110" name="__codelineno-7-110"></a><span class="w">        </span><span class="c1">// for reading does not exceed the size of the remaining data in the file.</span>
</span><span id="__span-7-111"><a id="__codelineno-7-111" name="__codelineno-7-111"></a><span class="w">        </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">Min</span><span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="o">,</span><span class="w"> </span><span class="p">(</span><span class="n">fStream</span><span class="o">.</span><span class="n">Size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">fStream</span><span class="o">.</span><span class="n">Position</span><span class="p">)</span><span class="w"> </span><span class="k">div</span><span class="w"> </span><span class="nb">SizeOf</span><span class="p">(</span><span class="kt">char</span><span class="p">))</span><span class="o">;</span>
</span><span id="__span-7-112"><a id="__codelineno-7-112" name="__codelineno-7-112"></a>
</span><span id="__span-7-113"><a id="__codelineno-7-113" name="__codelineno-7-113"></a><span class="w">        </span><span class="c1">// Read data into buffer</span>
</span><span id="__span-7-114"><a id="__codelineno-7-114" name="__codelineno-7-114"></a><span class="w">        </span><span class="n">fStream</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">,</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-115"><a id="__codelineno-7-115" name="__codelineno-7-115"></a>
</span><span id="__span-7-116"><a id="__codelineno-7-116" name="__codelineno-7-116"></a><span class="w">         </span><span class="c1">// Find the index of the last newline character in the buffer</span>
</span><span id="__span-7-117"><a id="__codelineno-7-117" name="__codelineno-7-117"></a><span class="w">        </span><span class="n">lastNewLine</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</span><span id="__span-7-118"><a id="__codelineno-7-118" name="__codelineno-7-118"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">downto</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-7-119"><a id="__codelineno-7-119" name="__codelineno-7-119"></a><span class="w">        </span><span class="k">begin</span>
</span><span id="__span-7-120"><a id="__codelineno-7-120" name="__codelineno-7-120"></a><span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">#10</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-7-121"><a id="__codelineno-7-121" name="__codelineno-7-121"></a><span class="w">          </span><span class="k">begin</span>
</span><span id="__span-7-122"><a id="__codelineno-7-122" name="__codelineno-7-122"></a><span class="w">            </span><span class="n">lastNewLine</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kp">index</span><span class="o">;</span>
</span><span id="__span-7-123"><a id="__codelineno-7-123" name="__codelineno-7-123"></a><span class="w">            </span><span class="k">Break</span><span class="o">;</span>
</span><span id="__span-7-124"><a id="__codelineno-7-124" name="__codelineno-7-124"></a><span class="w">          </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-125"><a id="__codelineno-7-125" name="__codelineno-7-125"></a><span class="w">        </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-126"><a id="__codelineno-7-126" name="__codelineno-7-126"></a>
</span><span id="__span-7-127"><a id="__codelineno-7-127" name="__codelineno-7-127"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">lastNewLine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-7-128"><a id="__codelineno-7-128" name="__codelineno-7-128"></a><span class="w">          </span><span class="n">lastNewLine</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="o">;</span>
</span><span id="__span-7-129"><a id="__codelineno-7-129" name="__codelineno-7-129"></a>
</span><span id="__span-7-130"><a id="__codelineno-7-130" name="__codelineno-7-130"></a><span class="w">        </span><span class="c1">// Create a thread to process the chunk and its size (index of \n + 1)</span>
</span><span id="__span-7-131"><a id="__codelineno-7-131" name="__codelineno-7-131"></a><span class="w">        </span><span class="n">threadList</span><span class="p">[</span><span class="n">activeThreads</span><span class="p">]</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">TFileChunkProcessor</span><span class="o">.</span><span class="n">Create</span><span class="p">(</span><span class="n">buffer</span><span class="o">,</span><span class="w"> </span><span class="n">lastNewLine</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-132"><a id="__codelineno-7-132" name="__codelineno-7-132"></a><span class="w">        </span><span class="n">threadList</span><span class="p">[</span><span class="n">activeThreads</span><span class="p">]</span><span class="o">.</span><span class="n">Start</span><span class="o">;</span>
</span><span id="__span-7-133"><a id="__codelineno-7-133" name="__codelineno-7-133"></a>
</span><span id="__span-7-134"><a id="__codelineno-7-134" name="__codelineno-7-134"></a><span class="w">        </span><span class="cm">{</span>
</span><span id="__span-7-135"><a id="__codelineno-7-135" name="__codelineno-7-135"></a><span class="cm">          Next, adjust file position to the character after the last newline.</span>
</span><span id="__span-7-136"><a id="__codelineno-7-136" name="__codelineno-7-136"></a>
</span><span id="__span-7-137"><a id="__codelineno-7-137" name="__codelineno-7-137"></a><span class="cm">          ---</span>
</span><span id="__span-7-138"><a id="__codelineno-7-138" name="__codelineno-7-138"></a><span class="cm">          Explanation</span>
</span><span id="__span-7-139"><a id="__codelineno-7-139" name="__codelineno-7-139"></a><span class="cm">          ---</span>
</span><span id="__span-7-140"><a id="__codelineno-7-140" name="__codelineno-7-140"></a>
</span><span id="__span-7-141"><a id="__codelineno-7-141" name="__codelineno-7-141"></a><span class="cm">          Let's say we have a buffer size of 1000 characters, and the last</span>
</span><span id="__span-7-142"><a id="__codelineno-7-142" name="__codelineno-7-142"></a><span class="cm">          newline character is found at index 950.</span>
</span><span id="__span-7-143"><a id="__codelineno-7-143" name="__codelineno-7-143"></a><span class="cm">          The buffer contains 50 characters after the last newline.</span>
</span><span id="__span-7-144"><a id="__codelineno-7-144" name="__codelineno-7-144"></a>
</span><span id="__span-7-145"><a id="__codelineno-7-145" name="__codelineno-7-145"></a><span class="cm">          bufferSize  = 1000</span>
</span><span id="__span-7-146"><a id="__codelineno-7-146" name="__codelineno-7-146"></a><span class="cm">          lastNewLine = 950</span>
</span><span id="__span-7-147"><a id="__codelineno-7-147" name="__codelineno-7-147"></a><span class="cm">          bufferSize - lastNewLine - 1 = 1000 - 950 - 1 = 49</span>
</span><span id="__span-7-148"><a id="__codelineno-7-148" name="__codelineno-7-148"></a><span class="cm">          Assuming SizeOf(Char) = 1 (for simplicity),</span>
</span><span id="__span-7-149"><a id="__codelineno-7-149" name="__codelineno-7-149"></a>
</span><span id="__span-7-150"><a id="__codelineno-7-150" name="__codelineno-7-150"></a><span class="cm">          ```pascal</span>
</span><span id="__span-7-151"><a id="__codelineno-7-151" name="__codelineno-7-151"></a><span class="cm">          fStream.Position := fStream.Position - 49 * SizeOf(Char);</span>
</span><span id="__span-7-152"><a id="__codelineno-7-152" name="__codelineno-7-152"></a><span class="cm">          ```</span>
</span><span id="__span-7-153"><a id="__codelineno-7-153" name="__codelineno-7-153"></a>
</span><span id="__span-7-154"><a id="__codelineno-7-154" name="__codelineno-7-154"></a><span class="cm">          This means the file position is moved back by 49 bytes, so the next</span>
</span><span id="__span-7-155"><a id="__codelineno-7-155" name="__codelineno-7-155"></a><span class="cm">          read operation will start at the 951st character in the buffer,</span>
</span><span id="__span-7-156"><a id="__codelineno-7-156" name="__codelineno-7-156"></a><span class="cm">          which is the character immediately following the last newline.</span>
</span><span id="__span-7-157"><a id="__codelineno-7-157" name="__codelineno-7-157"></a><span class="cm">          This ensures that no line is split between two chunks and maintains</span>
</span><span id="__span-7-158"><a id="__codelineno-7-158" name="__codelineno-7-158"></a><span class="cm">          the integrity of the data being processed.</span>
</span><span id="__span-7-159"><a id="__codelineno-7-159" name="__codelineno-7-159"></a><span class="cm">        }</span>
</span><span id="__span-7-160"><a id="__codelineno-7-160" name="__codelineno-7-160"></a><span class="w">        </span><span class="n">fStream</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="n">fStream</span><span class="o">.</span><span class="n">Position</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">bufferSize</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastNewLine</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nb">SizeOf</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-161"><a id="__codelineno-7-161" name="__codelineno-7-161"></a>
</span><span id="__span-7-162"><a id="__codelineno-7-162" name="__codelineno-7-162"></a><span class="w">        </span><span class="c1">// Increment active thread counter</span>
</span><span id="__span-7-163"><a id="__codelineno-7-163" name="__codelineno-7-163"></a><span class="w">        </span><span class="nb">Inc</span><span class="p">(</span><span class="n">activeThreads</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-164"><a id="__codelineno-7-164" name="__codelineno-7-164"></a>
</span><span id="__span-7-165"><a id="__codelineno-7-165" name="__codelineno-7-165"></a><span class="w">        </span><span class="c1">// If max threads are active, wait for them to finish</span>
</span><span id="__span-7-166"><a id="__codelineno-7-166" name="__codelineno-7-166"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">activeThreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAX_THREADS</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-7-167"><a id="__codelineno-7-167" name="__codelineno-7-167"></a><span class="w">        </span><span class="k">begin</span>
</span><span id="__span-7-168"><a id="__codelineno-7-168" name="__codelineno-7-168"></a><span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">MAX_THREADS</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-7-169"><a id="__codelineno-7-169" name="__codelineno-7-169"></a><span class="w">          </span><span class="k">begin</span>
</span><span id="__span-7-170"><a id="__codelineno-7-170" name="__codelineno-7-170"></a><span class="w">            </span><span class="n">threadList</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">.</span><span class="n">WaitFor</span><span class="o">;</span>
</span><span id="__span-7-171"><a id="__codelineno-7-171" name="__codelineno-7-171"></a><span class="w">          </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-172"><a id="__codelineno-7-172" name="__codelineno-7-172"></a><span class="w">          </span><span class="n">activeThreads</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="o">;</span>
</span><span id="__span-7-173"><a id="__codelineno-7-173" name="__codelineno-7-173"></a><span class="w">        </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-174"><a id="__codelineno-7-174" name="__codelineno-7-174"></a><span class="w">      </span><span class="k">end</span><span class="o">;</span><span class="w"> </span><span class="c1">// -- End of the `while fStream.Position &lt; fStream.Size do` loop.</span>
</span><span id="__span-7-175"><a id="__codelineno-7-175" name="__codelineno-7-175"></a>
</span><span id="__span-7-176"><a id="__codelineno-7-176" name="__codelineno-7-176"></a><span class="w">      </span><span class="c1">// Wait for any remaining threads to complete</span>
</span><span id="__span-7-177"><a id="__codelineno-7-177" name="__codelineno-7-177"></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="kp">index</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">activeThreads</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-7-178"><a id="__codelineno-7-178" name="__codelineno-7-178"></a><span class="w">      </span><span class="k">begin</span>
</span><span id="__span-7-179"><a id="__codelineno-7-179" name="__codelineno-7-179"></a><span class="w">        </span><span class="n">threadList</span><span class="p">[</span><span class="kp">index</span><span class="p">]</span><span class="o">.</span><span class="n">WaitFor</span><span class="o">;</span>
</span><span id="__span-7-180"><a id="__codelineno-7-180" name="__codelineno-7-180"></a><span class="w">      </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-181"><a id="__codelineno-7-181" name="__codelineno-7-181"></a>
</span><span id="__span-7-182"><a id="__codelineno-7-182" name="__codelineno-7-182"></a><span class="w">    </span><span class="k">finally</span>
</span><span id="__span-7-183"><a id="__codelineno-7-183" name="__codelineno-7-183"></a><span class="w">      </span><span class="n">fStream</span><span class="o">.</span><span class="n">Free</span><span class="o">;</span><span class="w"> </span><span class="c1">// Clean up the file stream</span>
</span><span id="__span-7-184"><a id="__codelineno-7-184" name="__codelineno-7-184"></a><span class="w">    </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-185"><a id="__codelineno-7-185" name="__codelineno-7-185"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-186"><a id="__codelineno-7-186" name="__codelineno-7-186"></a>
</span><span id="__span-7-187"><a id="__codelineno-7-187" name="__codelineno-7-187"></a><span class="w">  </span><span class="c1">// MAIN block ----------------------------------------------------------------</span>
</span><span id="__span-7-188"><a id="__codelineno-7-188" name="__codelineno-7-188"></a><span class="k">begin</span>
</span><span id="__span-7-189"><a id="__codelineno-7-189" name="__codelineno-7-189"></a>
</span><span id="__span-7-190"><a id="__codelineno-7-190" name="__codelineno-7-190"></a><span class="w">  </span><span class="c1">// Check if the input file exists</span>
</span><span id="__span-7-191"><a id="__codelineno-7-191" name="__codelineno-7-191"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nb">FileExists</span><span class="p">(</span><span class="nb">ParamStr</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-7-192"><a id="__codelineno-7-192" name="__codelineno-7-192"></a><span class="w">  </span><span class="k">begin</span>
</span><span id="__span-7-193"><a id="__codelineno-7-193" name="__codelineno-7-193"></a><span class="w">    </span><span class="nb">WriteLn</span><span class="p">(</span><span class="s">'File not found. Does '</span><span class="o">,</span><span class="w"> </span><span class="nb">ParamStr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">,</span><span class="w"> </span><span class="s">' exist?'</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-194"><a id="__codelineno-7-194" name="__codelineno-7-194"></a><span class="w">    </span><span class="k">Exit</span><span class="o">;</span>
</span><span id="__span-7-195"><a id="__codelineno-7-195" name="__codelineno-7-195"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-196"><a id="__codelineno-7-196" name="__codelineno-7-196"></a>
</span><span id="__span-7-197"><a id="__codelineno-7-197" name="__codelineno-7-197"></a><span class="w">  </span><span class="c1">// Parse the text file using multi-threading</span>
</span><span id="__span-7-198"><a id="__codelineno-7-198" name="__codelineno-7-198"></a><span class="w">  </span><span class="k">try</span>
</span><span id="__span-7-199"><a id="__codelineno-7-199" name="__codelineno-7-199"></a><span class="w">    </span><span class="n">ReadFileInChunks</span><span class="p">(</span><span class="nb">ParamStr</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">;</span>
</span><span id="__span-7-200"><a id="__codelineno-7-200" name="__codelineno-7-200"></a><span class="w">  </span><span class="k">except</span>
</span><span id="__span-7-201"><a id="__codelineno-7-201" name="__codelineno-7-201"></a><span class="w">    </span><span class="k">on</span><span class="w"> </span><span class="n">E</span><span class="o">:</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-7-202"><a id="__codelineno-7-202" name="__codelineno-7-202"></a><span class="w">      </span><span class="nb">Writeln</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">ClassName</span><span class="o">,</span><span class="w"> </span><span class="s">': '</span><span class="o">,</span><span class="w"> </span><span class="n">E</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span><span class="o">;</span>
</span><span id="__span-7-203"><a id="__codelineno-7-203" name="__codelineno-7-203"></a><span class="w">  </span><span class="k">end</span><span class="o">;</span>
</span><span id="__span-7-204"><a id="__codelineno-7-204" name="__codelineno-7-204"></a><span class="k">end</span><span class="o">.</span>
</span></code></pre></div></td></tr></tbody></table></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.path", "navigation.top", "toc.follow", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="../../../js/open_in_new_tab.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>